<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FireNet Telecom - Cadastro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"/>

  <style>
    /* Step wizard */
    .stepper { counter-reset: step; }
    .stepper .step-dot::before {
      counter-increment: step;
      content: counter(step);
      display: inline-flex; align-items:center; justify-content:center;
      width: 36px; height: 36px; border-radius: 50%;
      background: #dc3545; color: #fff; font-weight: 700;
    }
    .stepper .step-line { height: 2px; background: #e9ecef; }
    .stepper .active .step-dot::before { background: #dc3545; }
    .stepper .done .step-dot::before { background: #198754; }
    .step { display: none; }
    .step.active { display: block; }
  </style>
</head>
<body>

<header class="bg-white shadow-sm py-3 sticky-top">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <a href="/"><img src="{{ url_for('static', filename='logo.png') }}" alt="FireNet Telecom" class="logo-firenet"/></a>
      <nav class="d-none d-md-flex gap-4">
        <a href="/#inicio" class="nav-link text-dark fw-medium">Início</a>
        <a href="/#planos" class="nav-link text-dark fw-medium">Planos</a>
        <a href="/#vantagens" class="nav-link text-dark fw-medium">Vantagens</a>
        <a href="/#cobertura" class="nav-link text-dark fw-medium">Cobertura</a>
        <a href="/#central" class="nav-link text-dark fw-medium">Central do Cliente</a>
        <a href="/cadastro" class="nav-link text-dark fw-medium">Cadastro</a>
        <a href="/#contato" class="nav-link text-dark fw-medium">Contato</a>
      </nav>
      <button class="btn btn-outline-danger d-md-none" data-bs-toggle="collapse" data-bs-target="#navMobile">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <div class="collapse mt-3" id="navMobile">
      <nav class="d-flex flex-column text-center gap-2">
        <a href="/#inicio" class="py-2 text-dark">Início</a>
        <a href="/#planos" class="py-2 text-dark">Planos</a>
        <a href="/#vantagens" class="py-2 text-dark">Vantagens</a>
        <a href="/#cobertura" class="py-2 text-dark">Cobertura</a>
        <a href="/#central" class="py-2 text-dark">Central do Cliente</a>
        <a href="/cadastro" class="py-2 text-dark">Cadastro</a>
        <a href="/#contato" class="py-2 text-dark">Contato</a>
      </nav>
    </div>
  </div>
</header>

<section class="py-5 bg-light">
  <div class="container">
    <h2 class="text-center text-danger mb-4">Faça Seu Cadastro</h2>
    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <!-- Stepper -->
    <div class="stepper d-flex align-items-center gap-2 mb-4">
      <div class="text-center flex-fill">
        <div class="step-dot mx-auto"></div>
        <small class="d-block mt-2">Dados Pessoais</small>
      </div>
      <div class="step-line flex-fill"></div>
      <div class="text-center flex-fill">
        <div class="step-dot mx-auto"></div>
        <small class="d-block mt-2">Contato</small>
      </div>
      <div class="step-line flex-fill"></div>
      <div class="text-center flex-fill">
        <div class="step-dot mx-auto"></div>
        <small class="d-block mt-2">Endereço</small>
      </div>
      <div class="step-line flex-fill"></div>
      <div class="text-center flex-fill">
        <div class="step-dot mx-auto"></div>
        <small class="d-block mt-2">Plano & LGPD</small>
      </div>
    </div>

    <form action="/cadastro" method="POST" id="cadastro-form" novalidate>
      <!-- ETAPA 1: Dados pessoais -->
      <div class="step active" data-step="1">
        <div class="mb-3">
          <label for="nome" class="form-label">Qual é o seu nome completo? *</label>
          <input type="text" class="form-control" id="nome" name="nome" required/>
        </div>
        <div class="mb-3">
          <label for="cpf" class="form-label">Qual é seu CPF? *</label>
          <input type="text" class="form-control" id="cpf" name="cpf" required maxlength="14"/>
          <div id="cpf-error" class="text-danger" style="display:none">CPF inválido. Por favor, insira um CPF válido.</div>
          <div id="cpf-exists-error" class="text-danger" style="display:none">CPF já cadastrado, favor entrar em contato via WhatsApp.</div>
        </div>
        <div class="mb-3">
          <label for="rg" class="form-label">Qual seu RG (carteira de identidade)? *</label>
          <input type="text" class="form-control" id="rg" name="rg" required maxlength="12"/>
        </div>
        <div class="mb-3">
          <label for="data_nascimento" class="form-label">Qual é a sua data de nascimento? *</label>
          <input type="date" class="form-control" id="data_nascimento" name="data_nascimento" max="9999-12-31" required/>
        </div>
        <div class="d-flex justify-content-end">
          <button type="button" class="btn btn-danger rounded-pill" id="next-1" disabled>Prosseguir</button>
        </div>
      </div>

      <!-- ETAPA 2: Contato -->
      <div class="step" data-step="2">
        <div class="mb-3">
          <label for="telefone" class="form-label">Qual é o seu telefone de contato (com DDD)? *</label>
          <input type="tel" class="form-control" id="telefone" name="telefone" required maxlength="15"/>
        </div>
        <div class="mb-3">
          <label for="whatsapp" class="form-label">O número informado é WhatsApp? *</label>
          <select class="form-select" id="whatsapp" name="whatsapp" required>
            <option value="">Selecione uma opção</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">Qual é o seu e-mail? *</label>
          <input type="email" class="form-control" id="email" name="email" required/>
          <div id="email-error" class="text-danger" style="display:none">E-mail inválido. Por favor, insira um e-mail válido.</div>
        </div>
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-danger rounded-pill" id="back-2">Voltar</button>
          <button type="button" class="btn btn-danger rounded-pill" id="next-2" disabled>Prosseguir</button>
        </div>
      </div>

      <!-- ETAPA 3: Endereço -->
      <div class="step" data-step="3">
        <div class="mb-3">
          <label for="cep" class="form-label">Qual o seu CEP? *</label>
          <input type="text" class="form-control" id="cep" name="cep" required maxlength="9"/>
          <div id="cep-error" class="text-danger" style="display:none">Endereço inexistente. Por favor, insira um CEP válido.</div>
        </div>

        <!-- Endereço (display + hidden) -->
        <div class="mb-3">
          <label for="rua" class="form-label">Qual o seu endereço? *</label>
          <input type="text" class="form-control" id="rua" required readonly/>
          <input type="hidden" id="rua_hidden" name="rua"/>
          <input type="hidden" id="bairro" name="bairro"/>
          <input type="hidden" id="cidade" name="cidade"/>
          <input type="hidden" id="estado" name="estado"/>
        </div>

        <!-- Número + Complemento -->
        <div class="row g-3 mb-3">
          <div class="col-12 col-md-6">
            <label for="numero" class="form-label">Número da sua residência? *</label>
            <input type="text" class="form-control" id="numero" name="numero" required/>
          </div>
          <div class="col-12 col-md-6">
            <label for="complemento" class="form-label">Qual o complemento?</label>
            <input type="text" class="form-control" id="complemento" name="complemento"/>
          </div>
        </div>

        <div class="mb-3">
          <label for="ponto_referencia" class="form-label">Qual é o ponto de Referência? *</label>
          <input type="text" class="form-control" id="ponto_referencia" name="ponto_referencia" required/>
        </div>

        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-danger rounded-pill" id="back-3">Voltar</button>
          <button type="button" class="btn btn-danger rounded-pill" id="next-3" disabled>Prosseguir</button>
        </div>
      </div>

      <!-- ETAPA 4: Plano & LGPD -->
      <div class="step" data-step="4">
        <div class="mb-3">
          <label for="plano" class="form-label">Qual é o plano Desejado? *</label>
          <select class="form-select" id="plano" name="plano" required>
            <option value="">Selecione um plano</option>
            <option value="800 MEGA">800 MEGA - R$ 164,90</option>
            <option value="700 MEGA">700 MEGA - R$ 144,90</option>
            <option value="600 MEGA">600 MEGA - R$ 104,90</option>
            <option value="500 MEGA">500 MEGA - R$ 84,90</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="vencimento" class="form-label">Qual é o dia de vencimento desejado? *</label>
          <select class="form-select" id="vencimento" name="vencimento" required>
            <option value="">Selecione o dia de vencimento</option>
            <option value="Dia 5">Dia 5</option>
            <option value="Dia 10">Dia 10</option>
            <option value="Dia 15">Dia 15</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="nome_rede" class="form-label">Qual o nome da REDE WIFI que deseja? *</label>
          <input type="text" class="form-control" id="nome_rede" name="nome_rede" required/>
        </div>
        <div class="mb-3">
          <label for="senha_rede" class="form-label">E qual é a senha que deseja usar (mínimo 8 e máximo 10 caracteres)? *</label>
          <input type="text" class="form-control" id="senha_rede" name="senha_rede" required minlength="8" maxlength="10"/>
          <div id="senha-error" class="text-danger" style="display:none">A senha deve ter entre 8 e 10 caracteres.</div>
        </div>
        <div class="mb-3 form-check">
          <input type="checkbox" class="form-check-input" id="lgpd" name="lgpd" value="Sim" required/>
          <label class="form-check-label" for="lgpd">
            Declaro que estou fornecendo estas informações exclusivamente para fins de cadastro e formalização da assinatura do serviço de internet oferecido pela empresa FireNet. Estou ciente de que os dados enviados serão tratados de acordo com a LGPD (Lei nº 13.709/2018).
          </label>
        </div>

        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-danger rounded-pill" id="back-4">Voltar</button>
          <button type="submit" class="btn btn-danger rounded-pill" id="submit-btn" disabled>Enviar</button>
        </div>
      </div>
    </form>
  </div>
</section>

<footer class="bg-dark text-white py-4 text-center">
  <div class="container">
    <p class="mb-0">&copy; 2025 FireNet Telecom - Todos os direitos reservados.</p>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // ===== Utils =====
  const debounce = (fn, delay = 300) => {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
  };

  // ===== Helpers e máscaras (instantâneo) =====
  // Capitalizar nome
  document.getElementById('nome').addEventListener('input', function (e) {
    let v = e.target.value.toLowerCase();
    e.target.value = v.replace(/\b\w/g, ch => ch.toUpperCase());
  });

  // RG mask: XX.XXX.XXX-X
  document.getElementById('rg').addEventListener('input', function (e) {
    let v = e.target.value.replace(/\D/g, '');
    v = v.replace(/^(\d{2})(\d)/, '$1.$2');
    v = v.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
    v = v.replace(/^(\d{2})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3-$4');
    e.target.value = v.substring(0, 12);
  });

  // CPF mask + validação on input
  const cpfInput = document.getElementById('cpf');
  const cpfError = document.getElementById('cpf-error');
  const cpfExistsError = document.getElementById('cpf-exists-error');
  let cpfExists = false;

  cpfInput.addEventListener('input', function (e) {
    let v = e.target.value.replace(/\D/g, '');
    v = v.replace(/(\d{3})(\d)/, '$1.$2');
    v = v.replace(/(\d{3})\.(\d{3})(\d)/, '$1.$2.$3');
    v = v.replace(/(\d{3})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3-$4');
    e.target.value = v;

    // esconde erros enquanto digita
    cpfError.style.display = 'none';
    cpfExistsError.style.display = 'none';
    cpfExists = false;

    // valida local quando atingir 14 chars (formato)
    if (e.target.value.length === 14) {
      if (!validarCPF(e.target.value)) {
        cpfError.style.display = 'block';
      } else {
        debouncedCpfCheck(e.target.value); // checa no banco
      }
    }
    updateNavButtons();
  });

  const debouncedCpfCheck = debounce(async (cpfValue) => {
    const exists = await checkCpfExists(cpfValue);
    cpfExists = !!exists;
    cpfExistsError.style.display = cpfExists ? 'block' : 'none';
    updateNavButtons();
  }, 400);

  // Telefone mask + validação on input
  document.getElementById('telefone').addEventListener('input', function (e) {
    let v = e.target.value.replace(/\D/g, '');
    v = v.replace(/^(\d{2})(\d)/g, '($1) $2');
    v = v.replace(/(\d)(\d{4})$/, '$1-$2');
    e.target.value = v;
    updateNavButtons();
  });

  // Email validação on input
  const emailInput = document.getElementById('email');
  const emailError = document.getElementById('email-error');
  emailInput.addEventListener('input', function (e) {
    const emailRegex = /^[\w\.-]+@[\w\.-]+\.\w+$/;
    emailError.style.display = e.target.value && !emailRegex.test(e.target.value) ? 'block' : 'none';
    updateNavButtons();
  });

  // CEP mask + ViaCEP on input (ao atingir 8 dígitos)
  const cepInput = document.getElementById('cep');
  const cepError = document.getElementById('cep-error');
  cepInput.addEventListener('input', function (e) {
    let v = e.target.value.replace(/\D/g, '');
    // aplica máscara
    e.target.value = v.replace(/(\d{5})(\d)/, '$1-$2');

    if (v.length < 8) {
      cepError.style.display = 'none';
      clearAddressFields();
      updateNavButtons();
      return;
    }
    if (v.length === 8) {
      debouncedViaCep(v);
    }
  });

  const debouncedViaCep = debounce((cep) => {
    fetch(`https://viacep.com.br/ws/${cep}/json/`)
      .then(r => r.json())
      .then(data => {
        if (data.erro) {
          cepError.style.display = 'block';
          clearAddressFields();
        } else {
          cepError.style.display = 'none';
          const logradouro = data.logradouro || '';
          const bairro = data.bairro || '';
          const cidade = data.localidade || '';
          const uf = data.uf || '';
          const display = [logradouro, bairro, cidade, uf].filter(Boolean).join(', ');
          document.getElementById('rua').value = display;
          document.getElementById('rua_hidden').value = logradouro;
          document.getElementById('bairro').value = bairro;
          document.getElementById('cidade').value = cidade;
          document.getElementById('estado').value = uf;
        }
        updateNavButtons();
      })
      .catch(() => { cepError.style.display = 'block'; clearAddressFields(); updateNavButtons(); });
  }, 400);

  function clearAddressFields() {
    document.getElementById('rua').value = '';
    document.getElementById('rua_hidden').value = '';
    document.getElementById('bairro').value = '';
    document.getElementById('cidade').value = '';
    document.getElementById('estado').value = '';
  }

  // ===== Validadores básicos =====
  function validarCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
    let soma = 0, resto;
    for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i-1, i)) * (11 - i);
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(9, 10))) return false;
    soma = 0;
    for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i-1, i)) * (12 - i);
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(10, 11))) return false;
    return true;
  }

  async function checkCpfExists(cpfValue) {
    try {
      const response = await fetch('/check_cpf', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cpf: cpfValue.replace(/\D/g, '') })
      });
      const data = await response.json();
      return data.exists;
    } catch (err) {
      console.error('Erro ao checar CPF', err);
      return false;
    }
  }

  // ===== Navegação entre etapas =====
  const steps = Array.from(document.querySelectorAll('.step'));
  const stepperDots = Array.from(document.querySelectorAll('.stepper .step-dot').values());
  let current = 0; // 0..3

  function setStep(idx) {
    steps.forEach((s, i) => s.classList.toggle('active', i === idx));
    stepperDots.forEach((dot, i) => {
      dot.parentElement.classList.remove('active','done');
      if (i < idx) dot.parentElement.classList.add('done');
      if (i === idx) dot.parentElement.classList.add('active');
    });
    current = idx;
    updateNavButtons();      // controla "Prosseguir" da etapa
    updateSubmitState();     // controla "Enviar" na etapa 4
  }

  // Validações por etapa (instantâneas)
  function validateStep(idx) {
    if (idx === 0) {
      const nome = document.getElementById('nome');
      const cpfV = cpfInput.value;
      const rg = document.getElementById('rg');
      const dn = document.getElementById('data_nascimento');

      // reset visuais se ainda digitando
      if (cpfV.length < 14) { cpfError.style.display = 'none'; cpfExistsError.style.display = 'none'; }

      if (!nome.value.trim() || !rg.value.trim() || !dn.value) return false;
      if (cpfV.length !== 14 || !validarCPF(cpfV)) { return false; }
      if (cpfExists) { return false; }
      return true;
    }
    if (idx === 1) {
      const tel = document.getElementById('telefone');
      const wa = document.getElementById('whatsapp');
      const email = document.getElementById('email');
      const emailRegex = /^[\w\.-]+@[\w\.-]+\.\w+$/;
      const ok = !!tel.value.trim() && !!wa.value && !!email.value.trim() && emailRegex.test(email.value);
      return ok;
    }
    if (idx === 2) {
      const ruaVis = document.getElementById('rua').value.trim();
      const ruaHidden = document.getElementById('rua_hidden').value.trim();
      const bairro = document.getElementById('bairro').value.trim();
      const numero = document.getElementById('numero').value.trim();
      const pr = document.getElementById('ponto_referencia').value.trim();
      if (!ruaVis || !ruaHidden || !bairro || !numero || !pr) return false;
      if (cepError.style.display !== 'none') return false;
      return true;
    }
    if (idx === 3) {
      const plano = document.getElementById('plano').value;
      const venc = document.getElementById('vencimento').value;
      const nomeRede = document.getElementById('nome_rede').value.trim();
      const senha = document.getElementById('senha_rede').value;
      const lgpd = document.getElementById('lgpd').checked;
      const senhaOk = senha.length >= 8 && senha.length <= 10;
      document.getElementById('senha-error').style.display = senha && !senhaOk ? 'block' : 'none';
      return !!plano && !!venc && !!nomeRede && senhaOk && lgpd;
    }
    return true;
  }

  function updateNavButtons() {
    const next1 = document.getElementById('next-1');
    const next2 = document.getElementById('next-2');
    const next3 = document.getElementById('next-3');

    if (current === 0 && next1) next1.disabled = !validateStep(0);
    if (current === 1 && next2) next2.disabled = !validateStep(1);
    if (current === 2 && next3) next3.disabled = !validateStep(2);
  }

  // Revalida instantaneamente ao digitar/mudar/blur
  document.querySelectorAll('input, select').forEach(el => {
    el.addEventListener('input', () => { updateNavButtons(); if (current === 3) updateSubmitState(); });
    el.addEventListener('change', () => { updateNavButtons(); if (current === 3) updateSubmitState(); });
    el.addEventListener('blur',   () => { updateNavButtons(); if (current === 3) updateSubmitState(); });
  });

  // Botões de navegação
  document.getElementById('next-1').addEventListener('click', async () => {
    // segurança extra: rechecagem de CPF duplicado
    if (cpfInput.value.length === 14 && validarCPF(cpfInput.value)) {
      await debouncedCpfCheck.flush?.(); // se existir flush, útil; se não, segue
      const exists = await checkCpfExists(cpfInput.value);
      cpfExists = !!exists;
      if (cpfExists) cpfExistsError.style.display = 'block';
    }
    if (validateStep(0)) setStep(1);
  });
  document.getElementById('back-2').addEventListener('click', () => setStep(0));
  document.getElementById('next-2').addEventListener('click', () => { if (validateStep(1)) setStep(2); });

  document.getElementById('back-3').addEventListener('click', () => setStep(1));
  document.getElementById('next-3').addEventListener('click', () => { if (validateStep(2)) setStep(3); });

  document.getElementById('back-4').addEventListener('click', () => setStep(2));

  // Submit habilitado somente quando a última etapa estiver válida
  function updateSubmitState() {
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = !validateStep(3);
  }

  // Validação final no submit
  const form = document.getElementById('cadastro-form');
  form.addEventListener('submit', async function (e) {
    // última verificação de CPF duplicado
    if (cpfInput.value.length === 14 && validarCPF(cpfInput.value)) {
      const exists = await checkCpfExists(cpfInput.value);
      cpfExists = !!exists;
      if (cpfExists) cpfExistsError.style.display = 'block';
    }
    if (!validateStep(3)) {
      e.preventDefault();
      setStep(3);
      return;
    }
  });

  // Inicializa estado correto
  setStep(0);
</script>
</body>
</html>
