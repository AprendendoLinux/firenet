<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireNet Telecom - Cadastro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<!-- Header idêntico ao index.html -->
<header class="bg-white shadow-sm py-3 sticky-top">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <a href="/">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="FireNet Telecom" class="logo-firenet">
            </a>
            <nav class="d-none d-md-flex gap-4">
                <a href="/#inicio" class="nav-link text-dark fw-medium">Início</a>
                <a href="/#planos" class="nav-link text-dark fw-medium">Planos</a>
                <a href="/#vantagens" class="nav-link text-dark fw-medium">Vantagens</a>
                <a href="/#cobertura" class="nav-link text-dark fw-medium">Cobertura</a>
                <a href="/#central" class="nav-link text-dark fw-medium">Central do Cliente</a>
                <a href="/cadastro" class="nav-link text-dark fw-medium">Cadastro</a>
                <a href="/#contato" class="nav-link text-dark fw-medium">Contato</a>
            </nav>
            <button class="btn btn-outline-danger d-md-none" data-bs-toggle="collapse" data-bs-target="#navMobile">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <div class="collapse mt-3" id="navMobile">
            <nav class="d-flex flex-column text-center gap-2">
                <a href="/#inicio" class="py-2 text-dark">Início</a>
                <a href="/#planos" class="py-2 text-dark">Planos</a>
                <a href="/#vantagens" class="py-2 text-dark">Vantagens</a>
                <a href="/#cobertura" class="py-2 text-dark">Cobertura</a>
                <a href="/#central" class="py-2 text-dark">Central do Cliente</a>
                <a href="/cadastro" class="py-2 text-dark">Cadastro</a>
                <a href="/#contato" class="py-2 text-dark">Contato</a>
            </nav>
        </div>
    </div>
</header>

<!-- Formulário -->
<section class="py-5 bg-light">
    <div class="container">
        <h2 class="text-center text-danger mb-4">Faça Seu Cadastro</h2>
        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endif %}
        <form action="/cadastro" method="POST" id="cadastro-form">
            <div class="mb-3">
                <label for="nome" class="form-label">Qual é o seu nome completo? *</label>
                <input type="text" class="form-control" id="nome" name="nome" required>
            </div>
            <div class="mb-3">
                <label for="cpf" class="form-label">Qual é seu CPF? *</label>
                <input type="text" class="form-control" id="cpf" name="cpf" required maxlength="14">
                <div id="cpf-error" class="text-danger" style="display: none;">CPF inválido. Por favor, insira um CPF válido.</div>
                <div id="cpf-exists-error" class="text-danger" style="display: none;">CPF já cadastrado, favor entrar em contato via WhatsApp.</div>
            </div>
            <div class="mb-3">
                <label for="rg" class="form-label">Qual seu RG (carteira de identidade)? *</label>
                <input type="text" class="form-control" id="rg" name="rg" required maxlength="12">
            </div>
            <div class="mb-3">
                <label for="data_nascimento" class="form-label">Qual é a sua data de nascimento? *</label>
                <input type="date" max="9999-12-31" class="form-control" id="data_nascimento" name="data_nascimento" required>
            </div>
            <div class="mb-3">
                <label for="telefone" class="form-label">Qual é o seu telefone de contato (com DDD)? *</label>
                <input type="tel" class="form-control" id="telefone" name="telefone" required maxlength="15">
            </div>
            <div class="mb-3">
                <label for="whatsapp" class="form-label">O número informado é WhatsApp? *</label>
                <select class="form-select" id="whatsapp" name="whatsapp" required>
                    <option value="">Selecione uma opção</option>
                    <option value="Sim">Sim</option>
                    <option value="Não">Não</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">Qual é o seu e-mail? *</label>
                <input type="email" class="form-control" id="email" name="email" required>
                <div id="email-error" class="text-danger" style="display: none;">E-mail inválido. Por favor, insira um e-mail válido.</div>
            </div>
            <div class="mb-3">
                <label for="cep" class="form-label">Qual o seu CEP? *</label>
                <input type="text" class="form-control" id="cep" name="cep" required maxlength="9">
                <div id="cep-error" class="text-danger" style="display: none;">Endereço inexistente. Por favor, insira um CEP válido.</div>
            </div>
            <div class="mb-3">
                <label for="rua" class="form-label">Qual o seu endereço? *</label>
                <input type="text" class="form-control" id="rua" name="rua" required readonly>
            </div>
            <div class="mb-3">
                <label for="numero" class="form-label">Número da sua residência? *</label>
                <input type="text" class="form-control" id="numero" name="numero" required>
            </div>
            <div class="mb-3">
                <label for="complemento" class="form-label">Qual o complemento?</label>
                <input type="text" class="form-control" id="complemento" name="complemento">
            </div>
            <div class="mb-3">
                <label for="ponto_referencia" class="form-label">Qual é o ponto de Referência? *</label>
                <input type="text" class="form-control" id="ponto_referencia" name="ponto_referencia" required>
            </div>
            <div class="mb-3">
                <label for="bairro" class="form-label">Qual é o seu bairro? *</label>
                <input type="text" class="form-control" id="bairro" name="bairro" required readonly>
            </div>
            <div class="mb-3">
                <label for="plano" class="form-label">Qual é o plano Desejado? *</label>
                <select class="form-select" id="plano" name="plano" required>
                    <option value="">Selecione um plano</option>
                    <option value="800 MEGA">800 MEGA - R$ 164,90</option>
                    <option value="700 MEGA">700 MEGA - R$ 144,90</option>
                    <option value="600 MEGA">600 MEGA - R$ 104,90</option>
                    <option value="500 MEGA">500 MEGA - R$ 84,90</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="vencimento" class="form-label">Qual é o dia de vencimento desejado? *</label>
                <select class="form-select" id="vencimento" name="vencimento" required>
                    <option value="">Selecione o dia de vencimento</option>
                    <option value="Dia 5">Dia 5</option>
                    <option value="Dia 10">Dia 10</option>
                    <option value="Dia 15">Dia 15</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="nome_rede" class="form-label">Qual o nome da REDE WIFI que deseja? *</label>
                <input type="text" class="form-control" id="nome_rede" name="nome_rede" required>
            </div>
            <div class="mb-3">
                <label for="senha_rede" class="form-label">E qual é a senha que deseja usar (mínimo 8 e máximo 10 caracteres)? *</label>
                <input type="text" class="form-control" id="senha_rede" name="senha_rede" required minlength="8" maxlength="10">
                <div id="senha-error" class="text-danger" style="display: none;">A senha deve ter entre 8 e 10 caracteres.</div>
            </div>
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="lgpd" name="lgpd" value="Sim" required>
                <label class="form-check-label" for="lgpd">Declaro que estou fornecendo estas informações exclusivamente para fins de cadastro e formalização da assinatura do serviço de internet oferecido pela empresa FireNet. Estou ciente de que os dados enviados serão tratados de acordo com a Lei Geral de Proteção de Dados Pessoais (LGPD – Lei nº 13.709/2018), garantindo sua segurança, confidencialidade e utilização apenas para os propósitos especificados, conforme a política de privacidade da empresa.</label>
            </div>
            <button type="submit" class="btn btn-danger" id="submit-btn" disabled>Enviar</button>
        </form>
    </div>
</section>

<!-- JS para máscaras e validações -->
<script>
    // Capitalizar nome (primeira letra maiúscula em cada palavra)
    document.getElementById('nome').addEventListener('input', function (e) {
        let value = e.target.value.toLowerCase();
        e.target.value = value.replace(/\b\w/g, char => char.toUpperCase());
    });

    // Máscara RG: XX.XXX.XXX-X (somente números)
    document.getElementById('rg').addEventListener('input', function (e) {
        let v = e.target.value.replace(/\D/g, '');  // Remove não-dígitos
        v = v.replace(/^(\d{2})(\d)/, '$1.$2');
        v = v.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
        v = v.replace(/^(\d{2})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3-$4');
        e.target.value = v.substring(0, 12);  // Limita a 12 chars
    });

    // Função para validar CPF
    function validarCPF(cpf) {
        cpf = cpf.replace(/\D/g, '');
        if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
        let soma = 0, resto;
        for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i-1, i)) * (11 - i);
        resto = (soma * 10) % 11;
        if ((resto === 10) || (resto === 11)) resto = 0;
        if (resto !== parseInt(cpf.substring(9, 10))) return false;
        soma = 0;
        for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i-1, i)) * (12 - i);
        resto = (soma * 10) % 11;
        if ((resto === 10) || (resto === 11)) resto = 0;
        if (resto !== parseInt(cpf.substring(10, 11))) return false;
        return true;
    }

    // Variáveis para validações
    const cpfInput = document.getElementById('cpf');
    const cpfError = document.getElementById('cpf-error');
    const cpfExistsError = document.getElementById('cpf-exists-error');
    let cpfExists = false;

    // Função para checar se CPF existe no banco
    async function checkCpfExists(cpfValue) {
        try {
            const response = await fetch('/check_cpf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ cpf: cpfValue.replace(/\D/g, '') })
            });
            const data = await response.json();
            return data.exists;
        } catch (error) {
            console.error('Erro ao checar CPF:', error);
            return false; // Assumir não existe em caso de erro para não bloquear
        }
    }

    // Validação on blur para CPF (validação local e checagem de existência)
    cpfInput.addEventListener('blur', async function () {
        const cpfValue = cpfInput.value;
        cpfError.style.display = 'none';
        cpfExistsError.style.display = 'none';
        cpfExists = false;

        if (cpfValue.length === 14) {
            if (!validarCPF(cpfValue)) {
                cpfError.style.display = 'block';
            } else {
                // Checar se CPF já existe
                cpfExists = await checkCpfExists(cpfValue);
                if (cpfExists) {
                    cpfExistsError.style.display = 'block';
                }
            }
        }
        checkAllValid();
    });

    // Validação on blur para e-mail
    const emailInput = document.getElementById('email');
    const emailError = document.getElementById('email-error');
    emailInput.addEventListener('blur', function () {
        const emailRegex = /^[\w\.-]+@[\w\.-]+\.\w+$/;
        if (emailInput.value && !emailRegex.test(emailInput.value)) {
            emailError.style.display = 'block';
        } else {
            emailError.style.display = 'none';
        }
        checkAllValid();
    });

    // Validação on blur para senha
    const senhaInput = document.getElementById('senha_rede');
    const senhaError = document.getElementById('senha-error');
    senhaInput.addEventListener('blur', function () {
        const senhaValue = senhaInput.value;
        if (senhaValue.length > 0 && (senhaValue.length < 8 || senhaValue.length > 10)) {
            senhaError.style.display = 'block';
        } else {
            senhaError.style.display = 'none';
        }
        checkAllValid();
    });

    // Máscaras existentes (CPF, Telefone, CEP)
    document.getElementById('cpf').addEventListener('input', function (e) {
        let v = e.target.value.replace(/\D/g, '');
        v = v.replace(/(\d{3})(\d)/, '$1.$2');
        v = v.replace(/(\d{3})\.(\d{3})(\d)/, '$1.$2.$3');
        v = v.replace(/(\d{3})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3-$4');
        e.target.value = v;
        checkAllValid();
    });

    document.getElementById('telefone').addEventListener('input', function (e) {
        let v = e.target.value.replace(/\D/g, '');
        v = v.replace(/^(\d{2})(\d)/g, '($1) $2');
        v = v.replace(/(\d)(\d{4})$/, '$1-$2');
        e.target.value = v;
        checkAllValid();
    });

    document.getElementById('cep').addEventListener('input', function (e) {
        let v = e.target.value.replace(/\D/g, '');
        v = v.replace(/(\d{5})(\d)/, '$1-$2');
        e.target.value = v;
        checkAllValid();
    });

    // Validação on blur para CEP (com fetch na API)
    const cepInput = document.getElementById('cep');
    const cepError = document.getElementById('cep-error');
    cepInput.addEventListener('blur', function () {
        const cep = this.value.replace(/\D/g, '');
        cepError.style.display = 'none';
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(response => response.json())
                .then(data => {
                    if (data.erro) {
                        cepError.style.display = 'block';
                        document.getElementById('rua').value = '';
                        document.getElementById('bairro').value = '';
                    } else {
                        cepError.style.display = 'none';
                        document.getElementById('rua').value = data.logradouro;
                        document.getElementById('bairro').value = data.bairro;
                    }
                    checkAllValid();
                })
                .catch(() => {
                    cepError.style.display = 'block';
                    checkAllValid();
                });
        } else {
            checkAllValid();
        }
    });

    // Função para checar se todos os campos estão válidos
    function checkAllValid() {
        const form = document.getElementById('cadastro-form');
        const submitBtn = document.getElementById('submit-btn');
        let allValid = form.checkValidity(); // Verifica campos required nativos

        // Verificar erros personalizados
        if (cpfError.style.display !== 'none' || cpfExistsError.style.display !== 'none' || cpfExists) allValid = false;
        if (emailError.style.display !== 'none') allValid = false;
        if (senhaError.style.display !== 'none') allValid = false;
        if (cepError.style.display !== 'none') allValid = false;

        // Campos readonly como rua e bairro devem ter valor (preenchidos pelo CEP)
        if (document.getElementById('rua').value === '' || document.getElementById('bairro').value === '') allValid = false;

        submitBtn.disabled = !allValid;
    }

    // Adicionar listeners para todos os campos para checar em tempo real
    const inputs = document.querySelectorAll('input, select');
    inputs.forEach(input => {
        input.addEventListener('input', checkAllValid);
        input.addEventListener('change', checkAllValid);
        input.addEventListener('blur', checkAllValid);
    });

    // Validação no submit para checar CPF novamente de forma assíncrona
    const form = document.getElementById('cadastro-form');
    form.addEventListener('submit', async function (e) {
        e.preventDefault(); // Impede o submit padrão até a checagem

        checkAllValid();
        if (document.getElementById('submit-btn').disabled) {
            return;
        }

        const cpfValue = cpfInput.value;
        if (cpfValue.length === 14 && validarCPF(cpfValue)) {
            const exists = await checkCpfExists(cpfValue);
            if (exists) {
                cpfExistsError.style.display = 'block';
                cpfExists = true;
                checkAllValid();
                return;
            }
        }

        // Se tudo ok, submete o form
        form.submit();
    });
</script>

<footer class="bg-dark text-white py-4 text-center">
    <div class="container">
        <p class="mb-0">&copy; 2025 FireNet Telecom - Todos os direitos reservados.</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>