<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gerenciar Avisos - FireNet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-light">

{% include 'admin/menu.html' %}

<main>
    <div class="container py-5">
    
    <div class="row align-items-center mb-4 g-3">
        <div class="col-12 col-md">
            <h2 class="text-center text-md-start text-danger mb-0">Gerenciar Avisos</h2>
        </div>
        <div class="col-12 col-md-auto d-flex gap-2 flex-wrap justify-content-center">
            <button class="btn btn-danger px-4 fw-bold shadow-sm" onclick="abrirModalInteligente()">
                <i class="fas fa-magic me-2"></i>Aviso Inteligente
            </button>
            <button class="btn btn-danger px-4 fw-bold shadow-sm" onclick="abrirModalNovo()">
                <i class="fas fa-plus me-2"></i>Novo Aviso
            </button>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} shadow-sm rounded-3">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="card border-0 shadow-sm rounded-4 overflow-hidden d-none d-lg-block">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4 py-3 text-secondary text-uppercase small fw-bold">Título / Mensagem</th>
                            <th class="text-secondary text-uppercase small fw-bold">Tipo</th>
                            <th class="text-secondary text-uppercase small fw-bold">Programação</th>
                            <th class="text-secondary text-uppercase small fw-bold">Status</th>
                            <th class="text-end pe-4 text-secondary text-uppercase small fw-bold">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for aviso in avisos %}
                        
                        {# Lógica de Expiração #}
                        {% set expirado = False %}
                        {% if aviso.data_fim and aviso.data_fim < now %}
                            {% set expirado = True %}
                        {% endif %}

                        <tr class="{% if expirado %}opacity-50{% endif %}">
                            <td class="ps-4" style="max-width: 350px;">
                                <div class="fw-bold text-dark">
                                    {{ aviso.titulo }}
                                    {% if expirado %}<span class="badge bg-secondary ms-2" style="font-size: 0.6em;">EXPIRADO</span>{% endif %}
                                </div>
                                <div class="small text-muted text-truncate" title="{{ aviso.mensagem }}">{{ aviso.mensagem }}</div>
                            </td>
                            <td>
                                <span class="badge bg-danger-subtle text-danger border border-danger-subtle">
                                    {% if aviso.tipo == 'urgente' %}
                                        <i class="fas fa-exclamation-triangle me-1"></i> Urgente
                                    {% elif aviso.tipo == 'alerta' %}
                                        <i class="fas fa-exclamation-circle me-1"></i> Alerta
                                    {% else %}
                                        <i class="fas fa-bullhorn me-1"></i> Info
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                <div class="small text-muted">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="fas fa-play text-success me-2" style="width: 15px;"></i> 
                                        {{ aviso.data_inicio.strftime('%d/%m/%Y %H:%M') if aviso.data_inicio else 'Imediato' }}
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-stop text-danger me-2" style="width: 15px;"></i> 
                                        {{ aviso.data_fim.strftime('%d/%m/%Y %H:%M') if aviso.data_fim else 'Manual' }}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" style="cursor: pointer;"
                                           onchange="toggleAviso({{ aviso.id }})" 
                                           {% if aviso.ativo and not expirado %}checked{% endif %}
                                           {% if expirado %}disabled{% endif %}>
                                    <label class="form-check-label small text-muted">
                                        {% if expirado %}Expirado{% else %}{{ 'Ativo' if aviso.ativo else 'Inativo' }}{% endif %}
                                    </label>
                                </div>
                            </td>
                            <td class="text-end pe-4">
                                <button class="btn btn-outline-dark btn-sm border-0 me-1" onclick="editarAviso({{ aviso.id }})"><i class="fas fa-pen"></i></button>
                                <button class="btn btn-outline-danger btn-sm border-0" onclick="deleteAviso({{ aviso.id }})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="text-center py-5 text-muted"><i class="fas fa-inbox fa-3x mb-3 opacity-25"></i><br>Nenhum aviso cadastrado.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<div class="d-lg-none d-flex flex-column gap-3">
        {% for aviso in avisos %}
        {% set expirado = False %}
        {% if aviso.data_fim and aviso.data_fim < now %}{% set expirado = True %}{% endif %}

        <div class="card border-0 shadow-sm rounded-4 overflow-hidden {% if expirado %}opacity-75 bg-light{% endif %}">
            <div class="h-1 w-100 bg-danger" style="height: 5px;"></div>
            
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="fw-bold text-dark mb-0 pe-2">{{ aviso.titulo }}{% if expirado %}<span class="badge bg-secondary ms-2">EXPIRADO</span>{% endif %}</h6>
                    
                    <span class="badge bg-danger bg-opacity-10 text-danger border border-danger px-2">
                        {% if aviso.tipo == 'urgente' %}
                            <i class="fas fa-exclamation-triangle me-1"></i> Urgente
                        {% elif aviso.tipo == 'alerta' %}
                            <i class="fas fa-exclamation-circle me-1"></i> Alerta
                        {% else %}
                            <i class="fas fa-bullhorn me-1"></i> Info
                        {% endif %}
                    </span>
                </div>

                <p class="text-secondary small mb-3 text-truncate">{{ aviso.mensagem }}</p>
                <div class="bg-light rounded-3 p-2 mb-3 border">
                    <div class="d-flex justify-content-between small text-muted mb-1">
                        <span><i class="fas fa-play text-success me-1"></i> Início:</span><span class="fw-bold">{{ aviso.data_inicio.strftime('%d/%m/%y %H:%M') if aviso.data_inicio else 'Imediato' }}</span>
                    </div>
                    <div class="d-flex justify-content-between small text-muted">
                        <span><i class="fas fa-stop text-danger me-1"></i> Fim:</span><span class="fw-bold">{{ aviso.data_fim.strftime('%d/%m/%y %H:%M') if aviso.data_fim else 'Manual' }}</span>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center pt-2 border-top">
                    <div class="form-check form-switch mb-0">
                        <input class="form-check-input" type="checkbox" onchange="toggleAviso({{ aviso.id }})" {% if aviso.ativo and not expirado %}checked{% endif %} {% if expirado %}disabled{% endif %}>
                        <label class="form-check-label small ms-1 pt-1">{% if expirado %}Expirado{% else %}{{ 'Ativo' if aviso.ativo else 'Inativo' }}{% endif %}</label>
                    </div>
                    <div>
                        <button class="btn btn-outline-dark btn-sm me-1" onclick="editarAviso({{ aviso.id }})"><i class="fas fa-pen"></i> Editar</button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteAviso({{ aviso.id }})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-center py-5 text-muted"><i class="fas fa-inbox fa-3x mb-3 opacity-25"></i><br>Nenhum aviso cadastrado.</div>
        {% endfor %}
    </div>

<div class="modal fade" id="modalNovoAviso" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-danger text-white border-0 rounded-top-4">
                <h5 class="modal-title fw-bold" id="modalTitle">Novo Comunicado</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('salvar_aviso') }}" method="POST" id="formAviso">
                <div class="modal-body p-4">
                    <input type="hidden" name="id" id="avisoId">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Título</label>
                        <input type="text" name="titulo" id="avisoTitulo" class="form-control" placeholder="Ex: Manutenção Emergencial" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Mensagem</label>
                        <textarea name="mensagem" id="avisoMensagem" class="form-control" rows="4" placeholder="Detalhes do aviso..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tipo de Aviso</label>
                        <select name="tipo" id="avisoTipo" class="form-select">
                            <option value="info">Informativo (Ícone: Megafone)</option>
                            <option value="alerta">Alerta (Ícone: Exclamação)</option>
                            <option value="urgente">Urgente / Falha (Ícone: Triângulo)</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-12 col-md-6 mb-3">
                            <label class="form-label small text-muted fw-bold">Início (Opcional)</label>
                            <input type="datetime-local" name="data_inicio" id="avisoInicio" class="form-control">
                            <div class="form-text x-small">Vazio = Imediato</div>
                        </div>
                        <div class="col-12 col-md-6 mb-3">
                            <label class="form-label small text-muted fw-bold">Fim Automático</label>
                            <input type="datetime-local" name="data_fim" id="avisoFim" class="form-control">
                            <div class="form-text x-small">Vazio = Manual</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light border-0 rounded-bottom-4 justify-content-center py-3">
                    <button type="button" class="btn btn-outline-secondary px-4 rounded-pill fw-medium mx-1" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-outline-danger px-4 rounded-pill fw-bold mx-1">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalInteligente" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-danger text-white border-0 rounded-top-4">
                <h5 class="modal-title fw-bold"><i class="fas fa-magic me-2"></i>Aviso Inteligente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="text-muted small mb-3">Selecione as datas abaixo para gerar um aviso automático. O sistema agrupará datas consecutivas.</p>
                
                <div id="listaFeriados" class="list-group mb-3" style="max-height: 300px; overflow-y: auto;">
                    <div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Carregando datas...</div>
                </div>

                <div class="alert alert-info small py-2 d-none" id="infoSelecao">
                    <i class="fas fa-info-circle me-1"></i> <span id="textoSelecao">Nenhuma data selecionada</span>
                </div>
            </div>
                <div class="modal-footer bg-light border-0 rounded-bottom-4 justify-content-center py-3">
                    <button type="button" class="btn btn-outline-secondary px-4 rounded-pill fw-medium mx-1" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-outline-danger px-4 rounded-pill fw-bold mx-1" id="btnGerarInteligente" onclick="gerarAvisoInteligente()" disabled>Gerar Aviso</button>
                </div>
        </div>
    </div>
</div>

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="{{ url_for('static', filename='js/alertas.js') }}"></script>

{% include 'footer.html' %}

<script>
    let feriadosFuturos = [];

    // --- FUNÇÕES BÁSICAS ---
    function abrirModalNovo() {
        document.getElementById('modalTitle').innerText = 'Novo Comunicado';
        document.getElementById('formAviso').reset();
        document.getElementById('avisoId').value = ''; 
        new bootstrap.Modal(document.getElementById('modalNovoAviso')).show();
    }

    function editarAviso(id) {
        fetch(`/admin/avisos/get/${id}`)
            .then(r => r.json())
            .then(data => {
                if(data.error) { alert('Erro ao carregar dados'); return; }
                document.getElementById('modalTitle').innerText = 'Editar Comunicado';
                document.getElementById('avisoId').value = data.id;
                document.getElementById('avisoTitulo').value = data.titulo;
                document.getElementById('avisoMensagem').value = data.mensagem;
                document.getElementById('avisoTipo').value = data.tipo;
                document.getElementById('avisoInicio').value = data.data_inicio || '';
                document.getElementById('avisoFim').value = data.data_fim || '';
                new bootstrap.Modal(document.getElementById('modalNovoAviso')).show();
            });
    }

    function toggleAviso(id) {
        fetch(`/admin/avisos/toggle/${id}`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if(!data.success) alert(data.error || 'Erro ao alterar status');
                else location.reload();
            });
    }

    function deleteAviso(id) {
            ModalPadrao.fire({
                title: 'Excluir aviso?', 
                text: "Essa ação não pode ser desfeita.", 
                icon: 'warning',
                confirmButtonText: 'Sim'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/admin/avisos/delete/${id}`, { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if(data.success) location.reload();
                        else ModalPadrao.fire('Erro', 'Não foi possível excluir.', 'error');
                    });
                }
            });
        }

    // --- LÓGICA DO AVISO INTELIGENTE ---
    
    function abrirModalInteligente() {
        const modal = new bootstrap.Modal(document.getElementById('modalInteligente'));
        modal.show();
        
        // Carrega feriados
        fetch('/admin/get_feriados_futuros')
            .then(r => r.json())
            .then(data => {
                feriadosFuturos = data;
                renderizarListaFeriados();
            })
            .catch(err => {
                document.getElementById('listaFeriados').innerHTML = '<div class="text-danger text-center">Erro ao carregar datas.</div>';
            });
    }

    function renderizarListaFeriados() {
        const container = document.getElementById('listaFeriados');
        container.innerHTML = '';
        
        if (feriadosFuturos.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-3">Nenhum feriado futuro configurado.</div>';
            return;
        }

        feriadosFuturos.forEach((f, index) => {
            const div = document.createElement('div');
            div.className = 'list-group-item d-flex gap-3 align-items-center';
            div.innerHTML = `
                <input class="form-check-input flex-shrink-0" type="checkbox" value="${index}" id="chk_${index}" onchange="atualizarSelecao()">
                <label class="d-flex flex-column w-100 cursor-pointer" for="chk_${index}" style="cursor: pointer;">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold text-dark">${f.data_fmt}</span>
                        ${!f.ativo ? '<span class="badge bg-danger-subtle text-danger">Fechado</span>' : '<span class="badge bg-success-subtle text-success">Aberto ('+f.inicio+' - '+f.fim+')</span>'}
                    </div>
                    <small class="text-muted">${f.motivo}</small>
                </label>
            `;
            container.appendChild(div);
        });
    }

    function atualizarSelecao() {
        const checkboxes = document.querySelectorAll('#listaFeriados input:checked');
        const btn = document.getElementById('btnGerarInteligente');
        const info = document.getElementById('infoSelecao');
        
        btn.disabled = checkboxes.length === 0;
        
        if (checkboxes.length > 0) {
            info.classList.remove('d-none');
            document.getElementById('textoSelecao').innerText = `${checkboxes.length} data(s) selecionada(s). O sistema detectará intervalos automaticamente.`;
        } else {
            info.classList.add('d-none');
        }
    }

function gerarAvisoInteligente() {
        // 1. Coletar e Ordenar selecionados
        const checkboxes = document.querySelectorAll('#listaFeriados input:checked');
        let selecionados = [];
        checkboxes.forEach(chk => {
            selecionados.push(feriadosFuturos[chk.value]);
        });
        
        // Ordena por data (garantia de cronologia)
        selecionados.sort((a, b) => a.data_iso.localeCompare(b.data_iso));
        
        if (selecionados.length === 0) return;

        const primeiro = selecionados[0];
        const ultimo = selecionados[selecionados.length - 1];

        // --- INTELIGÊNCIA DE MOTIVOS ---
        const motivosIguais = selecionados.every(dia => dia.motivo === primeiro.motivo);

        let titulo = motivosIguais ? `Comunicado: ${primeiro.motivo}` : "Comunicado Importante";
        let motivoGeral = primeiro.motivo;

        // --- VERIFICAÇÕES DE UNIFORMIDADE ---
        const todosIguais = selecionados.every(dia => 
            dia.motivo === primeiro.motivo &&
            dia.ativo === primeiro.ativo && 
            dia.inicio === primeiro.inicio && 
            dia.fim === primeiro.fim
        );

        let consecutivos = true;
        for (let i = 0; i < selecionados.length - 1; i++) {
            const d1 = new Date(selecionados[i].data_iso);
            const d2 = new Date(selecionados[i+1].data_iso);
            const diffTime = Math.abs(d2 - d1);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays > 1) consecutivos = false;
        }

        let mensagem = "";

        if (selecionados.length > 1 && consecutivos && todosIguais) {
            if (!primeiro.ativo) {
                mensagem = `Informamos que no período de ${primeiro.data_fmt} a ${ultimo.data_fmt}, devido ao ${motivoGeral}, não haverá expediente.`;
            } else {
                mensagem = `Informamos que no período de ${primeiro.data_fmt} a ${ultimo.data_fmt}, devido ao ${motivoGeral}, nosso horário de atendimento será das ${primeiro.inicio} às ${primeiro.fim}.`;
            }
        } else if (selecionados.length === 1) {
            if (!primeiro.ativo) {
                mensagem = `Informamos que no dia ${primeiro.data_fmt}, devido ao ${motivoGeral}, não haverá expediente.`;
            } else {
                mensagem = `Informamos que no dia ${primeiro.data_fmt}, devido ao ${motivoGeral}, funcionaremos em horário especial: das ${primeiro.inicio} às ${primeiro.fim}.`;
            }
        } else {
            mensagem = motivosIguais 
                ? `Confira nossa programação para o ${motivoGeral}:\n` 
                : `Confira nossa programação para os próximos dias:\n`;
            
            selecionados.forEach(dia => {
                const prefixo = motivosIguais 
                    ? `• ${dia.data_fmt}` 
                    : `• ${dia.data_fmt} (${dia.motivo})`;

                if (!dia.ativo) {
                    mensagem += `\n${prefixo}: Não haverá expediente.`;
                } else {
                    mensagem += `\n${prefixo}: Funcionaremos das ${dia.inicio} às ${dia.fim}.`;
                }
            });
            
            mensagem += "\n\nContamos com a sua compreensão.";
        }

        let dataInicioObj = new Date(primeiro.data_iso + 'T08:00:00'); 
        dataInicioObj.setDate(dataInicioObj.getDate() - 3);
        
        if (dataInicioObj < new Date()) {
            dataInicioObj = new Date();
            dataInicioObj.setHours(dataInicioObj.getHours() + 1);
        }

        let dataFimObj = new Date(ultimo.data_iso + 'T23:59:00');

        const formatLocal = (date) => {
            const pad = (n) => n < 10 ? '0'+n : n;
            return date.getFullYear() + '-' + 
                   pad(date.getMonth()+1) + '-' + 
                   pad(date.getDate()) + 'T' + 
                   pad(date.getHours()) + ':' + 
                   pad(date.getMinutes());
        };

        bootstrap.Modal.getInstance(document.getElementById('modalInteligente')).hide();
        
        setTimeout(() => {
            abrirModalNovo(); 
            document.getElementById('avisoTitulo').value = titulo;
            document.getElementById('avisoMensagem').value = mensagem;
            document.getElementById('avisoTipo').value = 'info';
            document.getElementById('avisoInicio').value = formatLocal(dataInicioObj);
            document.getElementById('avisoFim').value = formatLocal(dataFimObj);
        }, 500);
    }
</script>
</body>
</html>