<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuários - FireNet Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Estilo dos Cards (Apenas Mobile/Tablet) */
        .user-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
        }
        .user-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
            border-color: rgba(220, 53, 69, 0.3);
        }
        /* Ajuste do cursor no olho da senha */
        .cursor-pointer {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-light">

    {% include 'admin/menu.html' %}

    <main>
        <section class="py-5">
            <div class="container">
                
                <div class="row align-items-center mb-4 g-3">
                    <div class="col-12 col-md">
                        <h2 class="text-center text-danger mb-4">Gerenciar Usuários</h2>
                    </div>
                    <div class="col-12 col-md-auto">
                        <button class="btn btn-danger rounded-pill px-4 fw-bold shadow-sm w-100 w-md-auto" data-bs-toggle="modal" data-bs-target="#modalNovoUsuario">
                            <i class="fas fa-plus me-2"></i>Novo Usuário
                        </button>
                    </div>
                </div>

                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} shadow-sm rounded-3">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden d-none d-lg-block">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4 py-3 text-secondary text-uppercase small fw-bold">ID</th>
                                        <th class="text-secondary text-uppercase small fw-bold">Usuário</th>
                                        <th class="text-secondary text-uppercase small fw-bold">E-mail</th>
                                        <th class="text-secondary text-uppercase small fw-bold">Telegram ID</th>
                                        <th class="text-end pe-4 text-secondary text-uppercase small fw-bold">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for usuario in usuarios %}
                                    <tr>
                                        <td class="ps-4 fw-bold text-muted">#{{ usuario.id }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="bg-danger bg-opacity-10 text-danger rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 35px; height: 35px;">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                                <span class="fw-bold text-dark">{{ usuario.username }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="text-muted">{{ usuario.email }}</span>
                                        </td>
                                        <td>
                                            {% if usuario.telegram_id %}
                                                <span class="badge bg-info bg-opacity-10 text-info border border-info"><i class="fab fa-telegram-plane me-1"></i>{{ usuario.telegram_id }}</span>
                                            {% else %}
                                                <span class="text-muted small fs-italic">Não configurado</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end pe-4">
                                            <button class="btn btn-outline-dark btn-sm border-0 me-1 btn-editar-usuario" 
                                                    data-usuario-id="{{ usuario.id }}" title="Editar">
                                                <i class="fas fa-pen"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm border-0 btn-apagar-usuario" 
                                                    data-usuario-id="{{ usuario.id }}" 
                                                    {% if usuario.id == session.get('user_id') %}disabled title="Você não pode se excluir"{% else %}title="Excluir"{% endif %}>
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center py-5 text-muted">
                                            <i class="fas fa-users-slash fa-3x mb-3 opacity-25"></i><br>
                                            Nenhum usuário encontrado.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="d-lg-none row g-3">
                    {% for usuario in usuarios %}
                    <div class="col-12 col-md-6">
                        <div class="user-card p-4 h-100 position-relative">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-danger bg-opacity-10 text-danger rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px; font-size: 1.2rem;">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <h5 class="fw-bold text-dark mb-0">{{ usuario.username }}</h5>
                                    <span class="badge bg-light text-muted border">ID: #{{ usuario.id }}</span>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <small class="text-uppercase text-muted fw-bold d-block" style="font-size: 0.7rem;">E-mail</small>
                                <div class="text-dark"><i class="fas fa-envelope text-muted me-2"></i>{{ usuario.email }}</div>
                            </div>
                            
                            <div class="mb-4">
                                <small class="text-uppercase text-muted fw-bold d-block" style="font-size: 0.7rem;">Telegram ID</small>
                                <div class="text-dark">
                                    {% if usuario.telegram_id %}
                                        <span class="text-info fw-medium"><i class="fab fa-telegram me-2"></i>{{ usuario.telegram_id }}</span>
                                    {% else %}
                                        <span class="text-muted fst-italic">Não vinculado</span>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="d-flex gap-2 border-top pt-3">
                                <button class="btn btn-outline-dark flex-grow-1 btn-editar-usuario" data-usuario-id="{{ usuario.id }}">
                                    <i class="fas fa-pen me-2"></i>Editar
                                </button>
                                <button class="btn btn-outline-danger flex-grow-1 btn-apagar-usuario" 
                                        data-usuario-id="{{ usuario.id }}" 
                                        {% if usuario.id == session.get('user_id') %}disabled{% endif %}>
                                    <i class="fas fa-trash me-2"></i>Excluir
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

            </div>
        </section>
    </main>

    <div class="modal fade" id="modalNovoUsuario" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold">Novo Usuário</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formNovoUsuario">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nome de Usuário</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">E-mail</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Senha</label>
                            <div class="input-group">
                                <input type="password" class="form-control" name="password" id="new_password" required>
                                <span class="input-group-text bg-white cursor-pointer" onclick="togglePassword('new_password', 'icon_new_pass')">
                                    <i class="fas fa-eye text-muted" id="icon_new_pass"></i>
                                </span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Confirmar Senha</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="new_confirm_password" required>
                                <span class="input-group-text bg-white cursor-pointer" onclick="togglePassword('new_confirm_password', 'icon_new_confirm')">
                                    <i class="fas fa-eye text-muted" id="icon_new_confirm"></i>
                                </span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Telegram ID (Opcional)</label>
                            <input type="text" class="form-control" name="telegram_id" placeholder="Ex: 123456789">
                            <div class="form-text">Para receber notificações do sistema.</div>
                        </div>
                        <button type="submit" class="btn btn-danger w-100 fw-bold shadow-sm">Criar Usuário</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEditarUsuario" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold">Editar Usuário</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formEditarUsuario">
                        <input type="hidden" name="usuario_id" id="edit_usuario_id">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nome de Usuário</label>
                            <input type="text" class="form-control" name="username" id="edit_username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">E-mail</label>
                            <input type="email" class="form-control" name="email" id="edit_email" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nova Senha</label>
                            <div class="input-group">
                                <input type="password" class="form-control" name="password" id="edit_password" placeholder="Deixe em branco para manter a atual">
                                <span class="input-group-text bg-white cursor-pointer" onclick="togglePassword('edit_password', 'icon_edit_pass')">
                                    <i class="fas fa-eye text-muted" id="icon_edit_pass"></i>
                                </span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Confirmar Nova Senha</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="edit_confirm_password" placeholder="Confirme apenas se alterar a senha">
                                <span class="input-group-text bg-white cursor-pointer" onclick="togglePassword('edit_confirm_password', 'icon_edit_confirm')">
                                    <i class="fas fa-eye text-muted" id="icon_edit_confirm"></i>
                                </span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Telegram ID</label>
                            <input type="text" class="form-control" name="telegram_id" id="edit_telegram_id">
                        </div>
                        <button type="submit" class="btn btn-danger w-100 fw-bold shadow-sm">Salvar Alterações</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalExcluir" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-body p-4 text-center">
                    <div class="text-danger mb-3">
                        <i class="fas fa-exclamation-circle fa-4x"></i>
                    </div>
                    <h4 class="fw-bold mb-2">Tem certeza?</h4>
                    <p class="text-muted">Essa ação removerá permanentemente o acesso deste usuário.</p>
                    <div class="d-flex justify-content-center gap-2 mt-4">
                        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger px-4" id="btnConfirmarExclusao">Sim, Excluir</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include 'footer.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Função para mostrar/ocultar senha
        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove("fa-eye");
                icon.classList.add("fa-eye-slash");
            } else {
                input.type = "password";
                icon.classList.remove("fa-eye-slash");
                icon.classList.add("fa-eye");
            }
        }

        // --- Scripts de Lógica ---

        // Novo Usuário
        document.getElementById('formNovoUsuario').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validação de Senha
            const p1 = document.getElementById('new_password').value;
            const p2 = document.getElementById('new_confirm_password').value;
            
            if (p1 !== p2) {
                alert('As senhas não coincidem!');
                return;
            }

            const formData = new FormData(this);
            const btn = this.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Criando...';
            btn.disabled = true;

            try {
                const res = await fetch('/admin/create_usuario', { method: 'POST', body: formData });
                const json = await res.json();
                if (json.success) {
                    location.reload();
                } else {
                    alert('Erro: ' + json.error);
                }
            } catch (err) {
                alert('Erro ao criar usuário.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // Preencher e Abrir Modal Editar
        const modalEditar = new bootstrap.Modal(document.getElementById('modalEditarUsuario'));
        
        document.addEventListener('click', async function(e) {
            const btn = e.target.closest('.btn-editar-usuario');
            if (btn) {
                const uid = btn.dataset.usuarioId;
                try {
                    const res = await fetch(`/admin/get_usuario/${uid}`);
                    const data = await res.json();
                    
                    if (data.error) {
                        alert(data.error);
                        return;
                    }

                    document.getElementById('edit_usuario_id').value = data.id;
                    document.getElementById('edit_username').value = data.username;
                    document.getElementById('edit_email').value = data.email;
                    document.getElementById('edit_telegram_id').value = data.telegram_id || '';
                    
                    // Limpar campos de senha
                    document.getElementById('edit_password').value = '';
                    document.getElementById('edit_confirm_password').value = '';

                    modalEditar.show();

                } catch (err) {
                    console.error(err);
                    alert('Erro ao buscar dados do usuário.');
                }
            }
        });

        // Salvar Edição
        document.getElementById('formEditarUsuario').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Validação de Senha (apenas se preencheu algo)
            const p1 = document.getElementById('edit_password').value;
            const p2 = document.getElementById('edit_confirm_password').value;
            
            if (p1 && p1 !== p2) {
                alert('A nova senha e a confirmação não coincidem!');
                return;
            }

            const uid = document.getElementById('edit_usuario_id').value;
            const formData = new FormData(this);
            
            try {
                const res = await fetch(`/admin/update_usuario/${uid}`, { method: 'POST', body: formData });
                const json = await res.json();
                if (json.success) {
                    location.reload();
                } else {
                    alert('Erro: ' + json.error);
                }
            } catch (err) {
                alert('Erro ao atualizar usuário.');
            }
        });

        // Excluir Usuário
        let usuarioIdParaExcluir = null;
        const modalExcluir = new bootstrap.Modal(document.getElementById('modalExcluir'));
        const btnConfirmarExclusao = document.getElementById('btnConfirmarExclusao');

        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn-apagar-usuario');
            if (btn && !btn.disabled) {
                usuarioIdParaExcluir = btn.dataset.usuarioId;
                modalExcluir.show();
            }
        });

        btnConfirmarExclusao.addEventListener('click', async () => {
            if (!usuarioIdParaExcluir) return;

            const originalText = btnConfirmarExclusao.innerHTML;
            btnConfirmarExclusao.innerHTML = 'Excluindo...';
            btnConfirmarExclusao.disabled = true;

            try {
                const res = await fetch(`/admin/delete_usuario/${usuarioIdParaExcluir}`, { method: 'POST' });
                const json = await res.json();
                
                if (json.success) {
                    location.reload();
                } else {
                    alert('Erro: ' + json.error);
                    modalExcluir.hide();
                }
            } catch (err) {
                console.error(err);
                alert('Erro ao apagar usuário.');
                modalExcluir.hide();
            } finally {
                btnConfirmarExclusao.innerHTML = originalText;
                btnConfirmarExclusao.disabled = false;
            }
        });
    </script>
</body>
</html>