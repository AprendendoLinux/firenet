<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ cliente.nome }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --fire-red: #dc3545;
            --fire-dark: #212529;
            --fire-gray: #6c757d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
        
        body { 
            background-color: #f5f5f5; 
            -webkit-print-color-adjust: exact; 
            print-color-adjust: exact; 
        }

        /* Configuração precisa para A4 */
        @page { 
            size: A4; 
            margin: 0; 
        }

        .page-container {
            width: 210mm;
            min-height: 297mm; /* Garante o tamanho da folha */
            padding: 15mm; /* 15mm é seguro e elegante */
            margin: 20px auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        @media print {
            body { background: white; margin: 0; }
            .page-container { 
                margin: 0; 
                box-shadow: none; 
                border: none; 
                page-break-after: avoid; 
                width: 210mm;
                height: 296mm; /* Força 1mm a menos para evitar página em branco extra */
                overflow: hidden; /* Segurança extra */
            }
            .no-print { display: none !important; }
        }

        /* Header Compacto mas Robusto */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 3px solid var(--fire-red); 
            padding-bottom: 10px; 
            margin-bottom: 20px; 
        }
        .logo img { height: 55px; max-width: 200px; object-fit: contain; }
        .header-info { text-align: right; }
        .header-info h1 { font-size: 18px; color: var(--fire-dark); text-transform: uppercase; margin-bottom: 3px; }
        .header-info p { font-size: 11px; color: var(--fire-gray); font-weight: 600; }

        /* Sections */
        .section { margin-bottom: 15px; } /* Reduzido de 22px para 15px */
        .section-title { 
            font-size: 11px; 
            font-weight: 700; 
            color: var(--fire-red); 
            text-transform: uppercase; 
            border-bottom: 1px solid #ddd; 
            padding-bottom: 3px; 
            margin-bottom: 8px; 
        }

        /* Grid - Otimizado para economizar altura */
        .data-grid { 
            display: grid; 
            grid-template-columns: repeat(12, 1fr); 
            gap: 10px; /* Reduzido de 15px para 10px */
        }
        .col-12 { grid-column: span 12; }
        .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }
        .col-3 { grid-column: span 3; }
        .col-2 { grid-column: span 2; }
        .col-7 { grid-column: span 7; }
        
        .label { 
            display: block; 
            font-size: 9px; 
            color: var(--fire-gray); 
            text-transform: uppercase; 
            margin-bottom: 2px; 
            font-weight: 700; 
        }
        
        /* Campos - Altura Controlada */
        .value { 
            display: block; 
            font-size: 12px; 
            color: var(--fire-dark); 
            font-weight: 600; 
            border: 1px solid #ccc; 
            padding: 7px 10px; /* Padding levemente menor */
            border-radius: 4px; 
            background: #fff; 
            min-height: 36px; /* Reduzido de 42px para 36px (ganho crítico de espaço) */
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }
        
        .value.highlight { 
            background-color: #fff3cd; 
            border-color: #ffecb5; 
            color: #856404; 
        }
        
        .value.obs { 
            white-space: normal; 
            height: auto; 
            min-height: 100px; /* 100px ainda é bastante espaço e ajuda na página única */
            line-height: 1.4;
        }

        /* Status Box */
        .status-box {
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: 800;
            font-size: 13px;
            border: 1px solid #ccc;
            text-transform: uppercase;
        }
        .st-concluida { background-color: #d1e7dd; color: #0f5132; border-color: #badbcc; }
        .st-programada { background-color: #fff3cd; color: #664d03; border-color: #ffecb5; }
        .st-nao-realizada { background-color: #f8d7da; color: #842029; border-color: #f5c2c7; }
        .st-pendente { background-color: #e2e3e5; color: #41464b; border-color: #d3d6d8; }

        /* Área de Assinatura Otimizada */
        .signature-area {
            margin-top: 50px; /* 50px é perfeito para Gov.br sem estourar a página */
            margin-bottom: 20px; 
            display: flex;
            justify-content: center;
            page-break-inside: avoid;
        }
        .signature-line {
            text-align: center;
            width: 50%;
        }
        .signature-line div { border-bottom: 1px solid #000; margin-bottom: 5px; }
        .signature-line p { font-size: 10px; font-weight: bold; text-transform: uppercase; color: #333; }

        /* Rodapé no Fluxo (Seguro) */
        footer {
            margin-top: auto; /* Empurra pro final apenas se sobrar espaço */
            text-align: center;
            font-size: 10px;
            color: #fff;
            background-color: var(--fire-red);
            padding: 10px 0;
            border-radius: 6px; 
            font-weight: 600;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        footer .sep {
            color: rgba(255,255,255, 0.5);
            font-weight: 400;
            margin: 0 8px;
        }

        /* Botão Imprimir */
        .fab-print {
            position: fixed; 
            top: 20px;
            right: 20px;
            background: var(--fire-red); color: white;
            width: 60px; height: 60px; font-size: 24px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer; border: none; z-index: 2000;
            transition: transform 0.2s, background-color 0.2s;
        }
        .fab-print:hover { transform: scale(1.1); background-color: #b02a37; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

    <button class="fab-print no-print" onclick="window.print()" title="Imprimir">
        <i class="fas fa-print"></i>
    </button>

    <div class="page-container">
        
        <header>
            <div class="logo">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="FireNet">
            </div>
            <div class="header-info">
                <h1>Ficha de Instalação</h1>
                <p>O.S. #{{ cliente.id }} • EMISSÃO: <span id="data-emissao">{{ current_date }}</span></p>
            </div>
        </header>

        <div class="section">
            <h2 class="section-title"><i class="fas fa-user-circle me-2"></i> Dados do Cliente</h2>
            <div class="data-grid">
                <div class="col-8">
                    <span class="label">Nome Completo</span>
                    <span class="value">{{ cliente.nome }}</span>
                </div>
                <div class="col-4">
                    <span class="label">CPF</span>
                    <span class="value format-cpf">{{ cliente.cpf }}</span>
                </div>

                <div class="col-4">
                    <span class="label">RG</span>
                    <span class="value format-rg">{{ cliente.rg }}</span>
                </div>
                <div class="col-4">
                    <span class="label">Data Nasc.</span>
                    <span class="value">{{ cliente.data_nascimento }}</span>
                </div>
                <div class="col-4">
                    <span class="label">Telefone / WhatsApp</span>
                    <span class="value" style="display: flex; align-items: center; justify-content: space-between;">
                        <span>{{ cliente.telefone }}</span>
                        {% if cliente.whatsapp == 'Sim' %}
                            <span style="color: #198754; font-weight: 800; font-size: 0.85em; display: flex; align-items: center;">
                                <i class="fab fa-whatsapp me-1" style="font-size: 1.1em;"></i> WhatsApp
                            </span>
                        {% else %}
                            <span style="color: #6c757d; font-size: 0.75em; font-weight: normal; font-style: italic;">(Apenas Voz)</span>
                        {% endif %}
                    </span>
                </div>
                
                <div class="col-12">
                    <span class="label">E-mail</span>
                    <span class="value">{{ cliente.email }}</span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title"><i class="fas fa-map-marker-alt me-2"></i> Endereço de Instalação</h2>
            <div class="data-grid">
                <div class="col-3">
                    <span class="label">CEP</span>
                    <span class="value">{{ cliente.cep }}</span>
                </div>
                <div class="col-7">
                    <span class="label">Logradouro</span>
                    <span class="value">{{ cliente.rua }}</span>
                </div>
                <div class="col-2">
                    <span class="label">Número</span>
                    <span class="value">{{ cliente.numero }}</span>
                </div>

                <div class="col-6">
                    <span class="label">Bairro</span>
                    <span class="value">{{ cliente.bairro }}</span>
                </div>
                <div class="col-6">
                    <span class="label">Complemento</span>
                    <span class="value">{{ cliente.complemento or '-' }}</span>
                </div>

                <div class="col-12">
                    <span class="label">Ponto de Referência</span>
                    <span class="value">{{ cliente.ponto_referencia }}</span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title"><i class="fas fa-network-wired me-2"></i> Dados Técnicos e Plano</h2>
            <div class="data-grid">
                <div class="col-4">
                    <span class="label">Plano Contratado</span>
                    <span class="value highlight">{{ cliente.plano }}</span>
                </div>
                <div class="col-4">
                    <span class="label">Vencimento</span>
                    <span class="value">Dia {{ cliente.vencimento }}</span>
                </div>
                <div class="col-4">
                    <span class="label">Aceite LGPD</span>
                    <span class="value">{{ cliente.lgpd }}</span>
                </div>

                <div class="col-6">
                    <span class="label">Nome da Rede (SSID Sugerido)</span>
                    <span class="value">{{ cliente.nome_rede }}</span>
                </div>
                <div class="col-6">
                    <span class="label">Senha da Rede (Sugerida)</span>
                    <span class="value">{{ cliente.senha_rede }}</span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title"><i class="fas fa-clipboard-check me-2"></i> Status e Agendamento</h2>
            <div class="data-grid">
                <div class="col-12">
                    <div class="status-box 
                        {% if cliente.status_instalacao == 'Concluída' %}st-concluida
                        {% elif cliente.status_instalacao == 'Programada' %}st-programada
                        {% elif cliente.status_instalacao == 'Não Realizada' %}st-nao-realizada
                        {% else %}st-pendente{% endif %}">
                        
                        {% if cliente.status_instalacao and cliente.status_instalacao != 'N/D' %}
                            STATUS: {{ cliente.status_instalacao|upper }}
                            {% if cliente.data_instalacao %} - PREVISÃO: {{ cliente.data_instalacao }} ({{ cliente.turno_instalacao }}){% endif %}
                        {% else %}
                            AGUARDANDO AGENDAMENTO
                        {% endif %}
                    </div>
                </div>
                <div class="col-12 mt-1">
                    <span class="label">Observações / Restrições</span>
                    <div class="value obs">{{ cliente.observacoes or 'Nenhuma observação registrada.' }}</div>
                </div>
            </div>
        </div>

        <div class="signature-area">
            <div class="signature-line">
                <div></div>
                <p>Vendedor Responsável</p>
            </div>
        </div>

        <footer>
            FireNet Telecomunicações <span class="sep">|</span> Desenvolvido por Henrique Fagundes <span class="sep">|</span> {{ app_version }}
        </footer>

    </div>

    <script>
        const dataEmissao = document.getElementById('data-emissao');
        if (!dataEmissao.innerText.trim() || dataEmissao.innerText.includes('None')) {
            const today = new Date().toLocaleDateString('pt-BR');
            dataEmissao.innerText = today;
        }

        document.querySelectorAll('.format-cpf').forEach(el => {
            let v = el.innerText.replace(/\D/g, '');
            if (v.length > 11) v = v.substring(0, 11);
            if (v.length >= 11) {
                el.innerText = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
            }
        });

        document.querySelectorAll('.format-rg').forEach(el => {
            let v = el.innerText.replace(/\D/g, '');
            if (v.length >= 8) { 
                el.innerText = v.replace(/^(\d{2})(\d{3})(\d{3})(\d{1}).*/, "$1.$2.$3-$4");
            }
        });
    </script>
</body>
</html>