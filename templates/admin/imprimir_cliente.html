<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ cliente.nome }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --fire-red: #dc3545;
            --fire-dark: #212529;
            --fire-gray: #6c757d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
        
        body { 
            background-color: #f5f5f5; 
            -webkit-print-color-adjust: exact; 
            print-color-adjust: exact; 
        }

        /* Zera margens do navegador para controle total */
        @page { size: A4; margin: 0; }

        .page-container {
            width: 210mm;
            height: 297mm; /* Força altura exata A4 */
            padding: 15mm; /* Margem interna */
            margin: 20px auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden; /* Corta qualquer excesso */
        }

        @media print {
            body { background: white; margin: 0; }
            .page-container { 
                margin: 0; 
                box-shadow: none; 
                width: 210mm; 
                height: 297mm; 
                border: none; 
                page-break-after: avoid; 
            }
            .no-print { display: none !important; }
        }

        /* Header Compacto */
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--fire-red); padding-bottom: 10px; margin-bottom: 15px; }
        .logo img { height: 50px; max-width: 180px; object-fit: contain; }
        .header-info { text-align: right; }
        .header-info h1 { font-size: 18px; color: var(--fire-dark); text-transform: uppercase; margin-bottom: 2px; }
        .header-info p { font-size: 10px; color: var(--fire-gray); }

        /* Sections Compactas */
        .section { margin-bottom: 12px; }
        .section-title { 
            font-size: 11px; 
            font-weight: 700; 
            color: var(--fire-red); 
            text-transform: uppercase; 
            border-bottom: 1px solid #ddd; 
            padding-bottom: 2px; 
            margin-bottom: 6px; 
        }

        /* Grid System Otimizado */
        .data-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 6px; }
        .col-12 { grid-column: span 12; }
        .col-8 { grid-column: span 8; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }
        .col-3 { grid-column: span 3; }
        .col-2 { grid-column: span 2; }
        .col-7 { grid-column: span 7; }

        .field-group { margin-bottom: 2px; }
        .label { display: block; font-size: 8px; color: var(--fire-gray); text-transform: uppercase; margin-bottom: 1px; font-weight: 600; }
        .value { display: block; font-size: 11px; color: var(--fire-dark); font-weight: 600; border: 1px solid #ccc; padding: 3px 5px; border-radius: 3px; background: #fff; min-height: 22px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .value.highlight { background-color: #fff3cd; border-color: #ffecb5; color: #856404; }
        .value.obs { white-space: normal; height: auto; min-height: 40px; }

        /* Status Box Pequeno */
        .status-box {
            padding: 4px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            font-size: 10px;
            border: 1px solid #ccc;
        }
        .st-concluida { background-color: #d1e7dd; color: #0f5132; border-color: #badbcc; }
        .st-programada { background-color: #fff3cd; color: #664d03; border-color: #ffecb5; }
        .st-nao-realizada { background-color: #f8d7da; color: #842029; border-color: #f5c2c7; }
        .st-pendente { background-color: #e2e3e5; color: #41464b; border-color: #d3d6d8; }

        /* Footer Fixo */
        footer {
            position: absolute;
            bottom: 15mm;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 9px;
            color: #666;
            padding-top: 5px;
            border-top: 1px solid #eee;
        }
        footer span.version { border-left: 1px solid #666; padding-left: 5px; margin-left: 5px; }

        /* Botão Imprimir */
        .fab-print {
            position: fixed; bottom: 20px; right: 20px;
            background: var(--fire-red); color: white;
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer; border: none; z-index: 1000;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

    <button class="fab-print no-print" onclick="window.print()" title="Imprimir">
        <i class="fas fa-print"></i>
    </button>

    <div class="page-container">
        
        <header>
            <div class="logo">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="FireNet">
            </div>
            <div class="header-info">
                <h1>Ficha de Instalação</h1>
                <p>Ordem de Serviço #{{ cliente.id }}</p>
                <p>Emissão: <span id="data-emissao">{{ current_date }}</span></p>
            </div>
        </header>

        <div class="section">
            <h2 class="section-title">Dados do Cliente</h2>
            <div class="data-grid">
                <div class="col-8 field-group">
                    <span class="label">Nome Completo</span>
                    <span class="value">{{ cliente.nome }}</span>
                </div>
                <div class="col-4 field-group">
                    <span class="label">CPF</span>
                    <span class="value format-cpf">{{ cliente.cpf }}</span>
                </div>

                <div class="col-4 field-group">
                    <span class="label">RG</span>
                    <span class="value format-rg">{{ cliente.rg }}</span>
                </div>
                <div class="col-4 field-group">
                    <span class="label">Data Nasc.</span>
                    <span class="value">{{ cliente.data_nascimento }}</span>
                </div>
                <div class="col-4 field-group">
                    <span class="label">Telefone / WhatsApp</span>
                    <span class="value">{{ cliente.telefone }}</span>
                </div>
                
                <div class="col-12 field-group">
                    <span class="label">E-mail</span>
                    <span class="value">{{ cliente.email }}</span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Endereço de Instalação</h2>
            <div class="data-grid">
                <div class="col-3 field-group">
                    <span class="label">CEP</span>
                    <span class="value">{{ cliente.cep }}</span>
                </div>
                <div class="col-7 field-group">
                    <span class="label">Logradouro</span>
                    <span class="value">{{ cliente.rua }}</span>
                </div>
                <div class="col-2 field-group">
                    <span class="label">Número</span>
                    <span class="value">{{ cliente.numero }}</span>
                </div>

                <div class="col-6 field-group">
                    <span class="label">Bairro</span>
                    <span class="value">{{ cliente.bairro }}</span>
                </div>
                <div class="col-6 field-group">
                    <span class="label">Complemento</span>
                    <span class="value">{{ cliente.complemento or '' }}</span>
                </div>

                <div class="col-12 field-group">
                    <span class="label">Ponto de Referência</span>
                    <span class="value">{{ cliente.ponto_referencia }}</span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Dados Técnicos e Plano</h2>
            <div class="data-grid">
                <div class="col-4 field-group">
                    <span class="label">Plano Contratado</span>
                    <span class="value highlight">{{ cliente.plano }}</span>
                </div>
                <div class="col-4 field-group">
                    <span class="label">Vencimento</span>
                    <span class="value">Todo dia {{ cliente.vencimento }}</span>
                </div>
                <div class="col-4 field-group">
                    <span class="label">Aceite LGPD</span>
                    <span class="value">{{ cliente.lgpd }}</span>
                </div>

                <div class="col-6 field-group">
                    <span class="label">Nome da Rede (SSID)</span>
                    <span class="value">{{ cliente.nome_rede }}</span>
                </div>
                <div class="col-6 field-group">
                    <span class="label">Senha da Rede</span>
                    <span class="value">{{ cliente.senha_rede }}</span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Status e Agendamento</h2>
            <div class="data-grid">
                <div class="col-12">
                    <div class="status-box 
                        {% if cliente.status_instalacao == 'Concluída' %}st-concluida
                        {% elif cliente.status_instalacao == 'Programada' %}st-programada
                        {% elif cliente.status_instalacao == 'Não Realizada' %}st-nao-realizada
                        {% else %}st-pendente{% endif %}">
                        STATUS ATUAL: {{ cliente.status_instalacao|upper }}
                        {% if cliente.data_instalacao %} - {{ cliente.data_instalacao }} ({{ cliente.turno_instalacao }}){% endif %}
                    </div>
                </div>
                <div class="col-12 mt-1">
                    <span class="label">Observações Técnicas</span>
                    <div class="value obs">{{ cliente.observacoes or 'Nenhuma observação registrada.' }}</div>
                </div>
            </div>
        </div>

        <div style="margin-top: 80px; display: flex; justify-content: center;">
            <div style="text-align: center; width: 50%;">
                <div style="border-bottom: 1px solid #000; margin-bottom: 5px;"></div>
                <p style="font-size: 10px; font-weight: bold;">Vendedor Responsável</p>
            </div>
        </div>

        <footer>
            Desenvolvido por Henrique Fagundes <span class="version" title="Versão do Sistema">Versão {{ app_version }}</span>
        </footer>

    </div>

    <script>
        // Fallback de data
        const dataEmissao = document.getElementById('data-emissao');
        if (!dataEmissao.innerText.trim() || dataEmissao.innerText.includes('None')) {
            const today = new Date().toLocaleDateString('pt-BR');
            dataEmissao.innerText = today;
        }

        // Formatação CPF (XXX.XXX.XXX-XX)
        document.querySelectorAll('.format-cpf').forEach(el => {
            let v = el.innerText.replace(/\D/g, '');
            if (v.length > 11) v = v.substring(0, 11);
            if (v.length >= 11) {
                el.innerText = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
            }
        });

        // Formatação RG (XX.XXX.XXX-X)
        document.querySelectorAll('.format-rg').forEach(el => {
            let v = el.innerText.replace(/\D/g, '');
            if (v.length >= 8) { 
                el.innerText = v.replace(/^(\d{2})(\d{3})(\d{3})(\d{1}).*/, "$1.$2.$3-$4");
            }
        });
    </script>
</body>
</html>