<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório #{{ identificador }} - FireNet</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --fire-red: #dc3545;
            --fire-dark: #212529;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
        
        body { 
            background-color: #f5f5f5; 
            -webkit-print-color-adjust: exact; 
            print-color-adjust: exact; 
        }

        /* Reset de Margem para evitar página em branco */
        @page { size: A4; margin: 0; }

        .page-container {
            width: 210mm;
            height: 297mm; /* Altura exata A4 */
            padding: 15mm;
            margin: 20px auto;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Corta excessos */
        }

        @media print {
            body { background: white; margin: 0; }
            .page-container { 
                margin: 0; 
                box-shadow: none; 
                width: 210mm; 
                height: 297mm; 
                border: none; 
                page-break-after: avoid; 
            }
            .no-print { display: none !important; }
        }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--fire-red); padding-bottom: 20px; margin-bottom: 30px; }
        .logo img { height: 60px; max-width: 200px; object-fit: contain; }
        .header-title h1 { font-size: 20px; color: var(--fire-dark); text-transform: uppercase; text-align: right; }
        .header-title p { font-size: 12px; color: #666; text-align: right; }

        /* Corpo do Relatório */
        .report-summary {
            background-color: #f8f9fa;
            border-left: 5px solid var(--fire-red);
            padding: 15px;
            margin-bottom: 30px;
        }
        .report-summary p { font-size: 14px; margin-bottom: 5px; color: #333; }
        .report-summary strong { color: var(--fire-dark); }

        /* Tabela */
        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 12px; }
        th { background-color: var(--fire-red); color: white; padding: 10px; text-transform: uppercase; text-align: left; font-size: 11px; }
        td { padding: 10px; border-bottom: 1px solid #ddd; color: #333; vertical-align: top; }
        tr:nth-child(even) { background-color: #f9f9f9; }

        /* Texto de Solicitação */
        .request-text {
            font-size: 14px;
            color: #333;
            line-height: 1.6;
            margin-top: 20px;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 5px;
        }

        /* Rodapé Fixo */
        footer {
            position: absolute;
            bottom: 15mm;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 11px;
            color: #666;
            padding-top: 20px;
        }
        footer span.version { border-left: 1px solid #666; padding-left: 8px; margin-left: 8px; }

        /* Botão Imprimir */
        .fab-print {
            position: fixed; bottom: 30px; right: 30px;
            background: var(--fire-red); color: white;
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer; border: none; z-index: 1000;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

    <button class="fab-print no-print" onclick="window.print()" title="Imprimir">
        <i class="fas fa-print"></i>
    </button>

    <div class="page-container">
        
        <header>
            <div class="logo">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="FireNet">
            </div>
            <div class="header-title">
                <h1>Relatório de Instalações</h1>
                <p>Uso Interno Administrativo</p>
            </div>
        </header>

        <div class="report-summary">
            <p><strong>Relatório Nº:</strong> #{{ identificador }}</p>
            
            <p><strong>Data de Emissão:</strong> 
                <span id="data-emissao">
                    {% if data_criacao.strftime is defined %}
                        {{ data_criacao.strftime('%d/%m/%Y') }}
                    {% else %}
                        {{ data_criacao }}
                    {% endif %}
                </span>
            </p>
            
            <p><strong>Vendedor Responsável:</strong> Luiz Henrique Marques Fagundes</p>
        </div>

        <p style="margin-bottom: 15px; font-size: 13px;">Segue abaixo a listagem de clientes com instalações <strong>CONCLUÍDAS</strong> inclusas neste lote:</p>

        <table>
            <thead>
                <tr>
                    <th style="width: 25%;">Cliente</th>
                    <th style="width: 15%;">CPF</th>
                    <th style="width: 45%;">Endereço Completo</th>
                    <th style="width: 15%;">Conclusão</th>
                </tr>
            </thead>
            <tbody>
                {% for cliente in clientes %}
                <tr>
                    <td><strong>{{ cliente.nome }}</strong></td>
                    <td class="format-cpf">{{ cliente.cpf }}</td>
                    <td>
                        {{ cliente.rua }}, {{ cliente.numero }}
                        {% if cliente.complemento %} - {{ cliente.complemento }}{% endif %}
                        <br><span style="color: #666; font-size: 10px;">{{ cliente.bairro }} - {{ cliente.cep }}</span>
                    </td>
                    <td><strong>{{ cliente.data_instalacao or 'N/A' }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="request-text">
            <p><strong>Solicitação de Baixa:</strong></p>
            <p>Confirmo a execução dos serviços acima listados e solicito a baixa do meu boleto de comissionamento/serviço com vencimento programado para <strong>{{ data_vencimento }}</strong>.</p>
        </div>

        <div style="margin-top: 80px; width: 50%; margin-left: auto; text-align: center;">
            <div style="border-bottom: 1px solid #000; margin-bottom: 5px;"></div>
            <p style="font-size: 12px; font-weight: bold;">Luiz Henrique Marques Fagundes</p>
            <p style="font-size: 10px; color: #666;">Vendedor Responsável</p>
        </div>

        <footer>
            Desenvolvido por Henrique Fagundes <span class="version" title="Versão do Sistema">Versão {{ app_version }}</span>
        </footer>

    </div>

    <script>
        // Formatar CPF na tabela do relatório
        document.querySelectorAll('.format-cpf').forEach(el => {
            let v = el.innerText.replace(/\D/g, '');
            if (v.length > 11) v = v.substring(0, 11);
            if (v.length >= 11) {
                el.innerText = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
            }
        });

        // Script de Segurança para Data: Se o Jinja não converteu (ex: veio string SQL), converte agora.
        const dataEl = document.getElementById('data-emissao');
        let textoData = dataEl.innerText.trim();
        
        // Verifica se tem formato de data por extenso ou SQL timestamp e força DD/MM/AAAA
        if (textoData.length > 10 || textoData.includes('-')) {
             try {
                const dateObj = new Date(textoData);
                if (!isNaN(dateObj.getTime())) {
                    dataEl.innerText = dateObj.toLocaleDateString('pt-BR');
                }
             } catch(e) {
                 console.log("Erro ao converter data", e);
             }
        }
    </script>
</body>
</html>