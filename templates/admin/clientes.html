<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - FireNet Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="bg-light">
    
    {% include 'admin/menu.html' %}

    <main>
        <section class="py-4 py-md-5">
            <div class="container">
                <h2 class="text-center text-danger mb-4">Lista de Clientes</h2>
                
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} shadow-sm">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body bg-white rounded">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <form method="GET" action="{{ url_for('clientes') }}" class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                                    <input type="text" id="busca-nome" name="busca_nome" class="form-control border-start-0 ps-0" placeholder="Buscar por Nome" value="{{ busca_nome or '' }}">
                                    <button class="btn btn-danger" type="submit">Buscar</button>
                                </form>
                            </div>
                            <div class="col-md-6">
                                <form method="GET" action="{{ url_for('clientes') }}" class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-id-card text-muted"></i></span>
                                    <input type="text" id="busca-cpf" name="busca_cpf" class="form-control border-start-0 ps-0" placeholder="Buscar por CPF" value="{{ busca_cpf or '' }}">
                                    <button class="btn btn-danger" type="submit">Buscar</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0 d-none d-lg-block">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="clientes-table">
                                <thead class="bg-light text-secondary small text-uppercase">
                                    <tr>
                                        <th class="ps-4">Nome</th>
                                        <th>Contatos</th>
                                        <th>Plano</th>
                                        <th>Instalação & Status</th>
                                        <th class="text-end pe-4">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cliente in cadastros %}
                                    <tr data-cliente-id="{{ cliente.id }}">
                                        <td class="ps-4">
                                            <div class="fw-bold text-dark nome">{{ cliente.nome }}</div>
                                            <small class="text-muted"><span class="cpf">{{ cliente.cpf }}</span></small>
                                        </td>
                                        <td>
                                            <div class="telefone"><i class="fas fa-phone-alt text-muted me-1 small"></i> {{ cliente.telefone }}</div>
                                        </td>
                                        <td>
                                            <span class="badge bg-light text-dark border px-3 py-2 rounded-pill plano">{{ cliente.plano }}</span>
                                        </td>
                                        
                                        <td>
                                            {% if cliente.status_instalacao == 'Concluída' %}
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-check-circle text-success fs-4 me-2"></i>
                                                    <div>
                                                        <span class="badge bg-success-subtle text-success border border-success-subtle mb-1">Concluída</span>
                                                        <div class="small fw-bold text-dark data-inst">
                                                            {{ cliente.data_instalacao or '--/--/----' }}
                                                        </div>
                                                    </div>
                                                </div>
                                            {% elif cliente.status_instalacao == 'Programada' %}
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-calendar-alt text-warning fs-4 me-2"></i>
                                                    <div>
                                                        <span class="badge bg-warning-subtle text-warning border border-warning-subtle mb-1">Programada</span>
                                                        <div class="small fw-bold text-dark data-inst">
                                                            {{ cliente.data_instalacao or '--/--/----' }}
                                                        </div>
                                                        <small class="text-muted d-block lh-1 turno-inst">{{ cliente.turno_instalacao or '' }}</small>
                                                    </div>
                                                </div>
                                            {% elif cliente.status_instalacao == 'Não Realizada' %}
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-times-circle text-danger fs-4 me-2"></i>
                                                    <div>
                                                        <span class="badge bg-danger-subtle text-danger border border-danger-subtle mb-1">Não Realizada</span>
                                                        <div class="small text-muted data-inst">{{ cliente.data_instalacao or 'Tentativa: --/--' }}</div>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-calendar-times text-secondary fs-4 me-2"></i>
                                                    <div>
                                                        <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle mb-1">Não Agendada</span>
                                                        <div class="small text-muted fst-italic">Aguardando...</div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </td>

                                        <td class="text-end pe-4">
                                            <button class="btn btn-sm btn-outline-dark btn-editar me-1" data-bs-toggle="modal" data-bs-target="#modalEditar" data-cliente-id="{{ cliente.id }}" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                                            <button class="btn btn-sm btn-outline-dark btn-agendar me-1" data-bs-toggle="modal" data-bs-target="#modalAgendar" data-cliente-id="{{ cliente.id }}" title="Agendar"><i class="fas fa-clock"></i></button>
                                            <a href="{{ url_for('imprimir_cliente', cliente_id=cliente.id) }}" class="btn btn-sm btn-outline-dark" target="_blank" title="Imprimir"><i class="fas fa-print"></i></a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="d-lg-none d-flex flex-column gap-3">
                    {% for cliente in cadastros %}
                    <div class="card shadow-sm border-0" data-cliente-id="{{ cliente.id }}">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h6 class="fw-bold text-dark mb-0 nome">{{ cliente.nome }}</h6>
                                    </div>
                                <span class="badge bg-light text-dark border plano">{{ cliente.plano }}</span>
                            </div>

                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">CPF</small>
                                    <span class="fw-medium small cpf">{{ cliente.cpf }}</span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">Telefone</small>
                                    <span class="fw-medium small telefone">{{ cliente.telefone }}</span>
                                </div>
                            </div>

                            <div class="bg-light p-2 rounded mb-3 border">
                                <div class="d-flex align-items-center">
                                    {% if cliente.status_instalacao == 'Concluída' %}
                                        <i class="fas fa-check-circle text-success fs-2 me-3"></i>
                                        <div>
                                            <span class="text-uppercase small fw-bold text-success d-block">Concluída</span>
                                            <span class="fw-bold text-dark data-inst">{{ cliente.data_instalacao or 'Data N/D' }}</span>
                                        </div>
                                    {% elif cliente.status_instalacao == 'Programada' %}
                                        <i class="fas fa-calendar-check text-warning fs-2 me-3"></i>
                                        <div>
                                            <span class="text-uppercase small fw-bold text-warning d-block">Agendada</span>
                                            <span class="fw-bold text-dark d-block data-inst">{{ cliente.data_instalacao or 'Data N/D' }}</span>
                                            <small class="text-muted turno-inst">{{ cliente.turno_instalacao }}</small>
                                        </div>
                                    {% elif cliente.status_instalacao == 'Não Realizada' %}
                                        <i class="fas fa-times-circle text-danger fs-2 me-3"></i>
                                        <div>
                                            <span class="text-uppercase small fw-bold text-danger d-block">Não Realizada</span>
                                            <span class="fw-bold text-dark data-inst">{{ cliente.data_instalacao or 'Data N/D' }}</span>
                                        </div>
                                    {% else %}
                                        <i class="fas fa-calendar-times text-secondary fs-2 me-3"></i>
                                        <div>
                                            <span class="text-uppercase small fw-bold text-secondary d-block">Não Agendada</span>
                                            <small class="text-muted">Aguardando...</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-dark flex-grow-1 btn-editar" data-bs-toggle="modal" data-bs-target="#modalEditar" data-cliente-id="{{ cliente.id }}">
                                    <i class="fas fa-pencil-alt"></i> Editar
                                </button>
                                <button class="btn btn-outline-dark flex-grow-1 btn-agendar" data-bs-toggle="modal" data-bs-target="#modalAgendar" data-cliente-id="{{ cliente.id }}">
                                    <i class="fas fa-clock"></i> Agendar
                                </button>
                                <a href="{{ url_for('imprimir_cliente', cliente_id=cliente.id) }}" class="btn btn-outline-dark" target="_blank">
                                    <i class="fas fa-print"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="d-flex justify-content-center mt-4">
                    <a href="{{ url_for('clientes', page=current_page - 1, busca_nome=busca_nome, busca_cpf=busca_cpf) }}" class="btn btn-outline-danger me-2 {% if current_page == 1 %}disabled{% endif %}">
                        <i class="fas fa-chevron-left"></i> Anterior
                    </a>
                    <span class="align-self-center mx-3 fw-bold text-muted">Página {{ current_page }} de {{ total_pages }}</span>
                    <a href="{{ url_for('clientes', page=current_page + 1, busca_nome=busca_nome, busca_cpf=busca_cpf) }}" class="btn btn-outline-danger ms-2 {% if current_page >= total_pages %}disabled{% endif %}">
                        Próxima <i class="fas fa-chevron-right"></i>
                    </a>
                </div>
            </div>
        </section>
    </main>

    <div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold"><i class="fas fa-user-edit me-2"></i>Editar Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formEditar" method="POST">
                        <input type="hidden" id="editar-cliente-id" name="cliente_id">
                        
                        <h6 class="text-danger border-bottom pb-2 mb-3 fw-bold">DADOS PESSOAIS</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6"><label class="form-label small fw-bold text-muted">Nome Completo</label><input type="text" class="form-control" id="editar-nome" name="nome" required></div>
                            <div class="col-md-3"><label class="form-label small fw-bold text-muted">CPF</label><input type="text" class="form-control" id="editar-cpf" name="cpf" required></div>
                            <div class="col-md-3"><label class="form-label small fw-bold text-muted">RG</label><input type="text" class="form-control" id="editar-rg" name="rg" required></div>
                            <div class="col-md-3"><label class="form-label small fw-bold text-muted">Nascimento</label><input type="date" class="form-control" id="editar-data_nascimento" name="data_nascimento" required></div>
                            <div class="col-md-3"><label class="form-label small fw-bold text-muted">Telefone</label><input type="text" class="form-control" id="editar-telefone" name="telefone" required></div>
                            <div class="col-md-2"><label class="form-label small fw-bold text-muted">WhatsApp?</label><select class="form-select" id="editar-whatsapp" name="whatsapp"><option value="Sim">Sim</option><option value="Não">Não</option></select></div>
                            <div class="col-md-4"><label class="form-label small fw-bold text-muted">E-mail</label><input type="email" class="form-control" id="editar-email" name="email" required></div>
                        </div>

                        <h6 class="text-danger border-bottom pb-2 mb-3 fw-bold">ENDEREÇO DE INSTALAÇÃO</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-3"><label class="form-label small fw-bold text-muted">CEP</label><input type="text" class="form-control" id="editar-cep" name="cep" required></div>
                            <div class="col-md-6"><label class="form-label small fw-bold text-muted">Rua</label><input type="text" class="form-control" id="editar-rua" name="rua" required></div>
                            <div class="col-md-3"><label class="form-label small fw-bold text-muted">Número</label><input type="text" class="form-control" id="editar-numero" name="numero" required></div>
                            <div class="col-md-4"><label class="form-label small fw-bold text-muted">Bairro</label><input type="text" class="form-control" id="editar-bairro" name="bairro" required></div>
                            <div class="col-md-4"><label class="form-label small fw-bold text-muted">Complemento</label><input type="text" class="form-control" id="editar-complemento" name="complemento"></div>
                            <div class="col-md-4"><label class="form-label small fw-bold text-muted">Ponto de Referência</label><input type="text" class="form-control" id="editar-ponto_referencia" name="ponto_referencia" required></div>
                        </div>

                        <h6 class="text-danger border-bottom pb-2 mb-3 fw-bold">PLANO & REDE</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4"><label class="form-label small fw-bold text-muted">Plano</label><select class="form-select" id="editar-plano" name="plano" required><option value="500 MEGAS">500 MEGAS</option><option value="700 MEGAS">700 MEGAS</option><option value="1 GIGA">1 GIGA</option></select></div>
                            <div class="col-md-4"><label class="form-label small fw-bold text-muted">Vencimento</label><select class="form-select" id="editar-vencimento" name="vencimento" required><option value="Dia 5">Dia 5</option><option value="Dia 10">Dia 10</option><option value="Dia 15">Dia 15</option></select></div>
                            <div class="col-md-4 d-flex align-items-end"><div class="form-check"><input class="form-check-input" type="checkbox" id="editar-lgpd" name="lgpd" value="Sim"><label class="form-check-label small" for="editar-lgpd">Aceite LGPD</label></div></div>
                            <div class="col-md-6"><label class="form-label small fw-bold text-muted">Nome da Rede (SSID)</label><input type="text" class="form-control" id="editar-nome_rede" name="nome_rede" required></div>
                            <div class="col-md-6"><label class="form-label small fw-bold text-muted">Senha da Rede</label><input type="text" class="form-control" id="editar-senha_rede" name="senha_rede" required></div>
                        </div>

                        <button type="submit" class="btn btn-danger w-100 py-2 fw-bold shadow-sm">SALVAR ALTERAÇÕES</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalAgendar" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold"><i class="fas fa-calendar-alt me-2"></i>Agendar / Atualizar</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formAgendar" method="POST">
                        <input type="hidden" id="agendar-cliente-id" name="cliente_id">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small">Status da Instalação</label>
                            <select class="form-select border-2" id="agendar-status_instalacao" name="status_instalacao">
                                <option value="N/D">Não Agendada (N/D)</option>
                                <option value="Programada">Programada</option>
                                <option value="Concluída">Concluída</option>
                                <option value="Não Realizada">Não Realizada</option>
                            </select>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label fw-bold text-muted small">Data</label>
                                <input type="date" class="form-control" id="agendar-data_instalacao" name="data_instalacao">
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold text-muted small">Turno</label>
                                <select class="form-select" id="agendar-turno_instalacao" name="turno_instalacao">
                                    <option value="Horário Comercial">Horário Comercial</option>
                                    <option value="Manhã">Manhã</option>
                                    <option value="Tarde">Tarde</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted small">Observações</label>
                            <textarea class="form-control" id="agendar-observacoes" name="observacoes" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-danger w-100 fw-bold shadow-sm">SALVAR AGENDAMENTO</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalRelatorioPendente" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-body text-center p-4">
                    <i class="fas fa-file-invoice text-primary fa-3x mb-3"></i>
                    <h5 class="fw-bold">Relatório Necessário</h5>
                    <p class="text-muted small">Você já tem 3 instalações concluídas pendentes. Emita o relatório antes de concluir mais.</p>
                    <div class="d-flex justify-content-center gap-2 mt-3">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
                        <a href="{{ url_for('admin_relatorios') }}" class="btn btn-primary btn-sm">Ir para Relatórios</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include 'footer.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="{{ url_for('static', filename='js/alertas.js') }}"></script>

    <script>
        // Scripts de Máscaras e Modais (Mantidos)
        function aplicarMascaras(prefix) {
            const cpf = document.getElementById(`${prefix}-cpf`);
            if (cpf) cpf.addEventListener('input', e => {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 11) v = v.slice(0, 11);
                v = v.replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                e.target.value = v;
            });
            const tel = document.getElementById(`${prefix}-telefone`);
            if (tel) tel.addEventListener('input', e => {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 11) v = v.slice(0, 11);
                v = v.replace(/^(\d{2})(\d)/, '($1) $2').replace(/(\d{5})(\d{1,4})$/, '$1-$2');
                e.target.value = v;
            });
            const cep = document.getElementById(`${prefix}-cep`);
            if (cep) cep.addEventListener('input', e => {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 8) v = v.slice(0, 8);
                v = v.replace(/^(\d{5})(\d)/, '$1-$2');
                e.target.value = v;
            });
        }
        aplicarMascaras('editar');

        document.addEventListener('click', async function(e) {
            const btn = e.target.closest('.btn-editar, .btn-agendar');
            if (!btn) return;

            const clienteId = btn.dataset.clienteId;
            const isEditar = btn.classList.contains('btn-editar');
            const prefix = isEditar ? 'editar' : 'agendar';
            
            try {
                const res = await fetch(`/admin/get_cliente/${clienteId}`);
                if (!res.ok) throw new Error('Erro na API');
                const data = await res.json();
                
                document.getElementById(`${prefix}-cliente-id`).value = clienteId;

                if (isEditar) {
                    ['nome','cpf','rg','telefone','email','cep','rua','numero','complemento','ponto_referencia','bairro','plano','vencimento','nome_rede','senha_rede'].forEach(f => {
                         if(document.getElementById(`editar-${f}`)) document.getElementById(`editar-${f}`).value = data[f] || '';
                    });
                    document.getElementById('editar-whatsapp').value = data.whatsapp || 'Não';
                    document.getElementById('editar-lgpd').checked = data.lgpd === 'Sim';
                    
                    if (data.data_nascimento) {
                        const parts = data.data_nascimento.split('/');
                        if (parts.length === 3) document.getElementById('editar-data_nascimento').value = `${parts[2]}-${parts[1]}-${parts[0]}`;
                    }
                } else {
                    document.getElementById('agendar-status_instalacao').value = data.status_instalacao || 'N/D';
                    document.getElementById('agendar-turno_instalacao').value = data.turno_instalacao || 'Horário Comercial';
                    document.getElementById('agendar-observacoes').value = data.observacoes || '';
                    
                    if (data.data_instalacao) {
                        const parts = data.data_instalacao.split('/');
                        if (parts.length === 3) document.getElementById('agendar-data_instalacao').value = `${parts[2]}-${parts[1]}-${parts[0]}`;
                    } else {
                        document.getElementById('agendar-data_instalacao').value = '';
                    }
                }
            } catch (err) {
                alert('Erro ao carregar dados do cliente.');
            }
        });

        ['formEditar', 'formAgendar'].forEach(id => {
            document.getElementById(id).addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const cid = this.querySelector('[name="cliente_id"]').value;
                const url = id === 'formEditar' ? `/admin/update_cliente/${cid}` : `/admin/update_agendamento/${cid}`;
                
                try {
                    const res = await fetch(url, { method: 'POST', body: formData });
                    const json = await res.json();
                    
                    if (json.success) {
                        location.reload();
                    } else if (json.error && json.error.includes('emitir o relatório')) {
                        bootstrap.Modal.getInstance(this.closest('.modal')).hide();
                        new bootstrap.Modal(document.getElementById('modalRelatorioPendente')).show();
                    } else {
                        alert('Erro: ' + json.error);
                    }
                } catch (err) {
                    alert('Erro ao salvar.');
                }
            });
        });

        document.querySelectorAll('.cpf').forEach(el => {
            let v = el.innerText.replace(/\D/g,'');
            if(v.length===11) el.innerText = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        });
        document.querySelectorAll('.telefone').forEach(el => {
            let v = el.innerText.replace(/\D/g,'');
            if(v.length===11) el.innerText = v.replace(/^(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            else if(v.length===10) el.innerText = v.replace(/^(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
        });
    </script>
</body>
</html>