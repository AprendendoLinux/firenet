<div class="whats-button">
    <a href="#" data-bs-toggle="modal" data-bs-target="#modalAtendenteVirtual" title="Falar com a FireNet">
        <img loading="lazy" src="{{ url_for('static', filename='whatsapp.webp') }}" alt="WhatsApp" class="img-fluid">
    </a>
</div>

<div class="modal fade" id="modalAtendenteVirtual" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg" style="min-height: 600px;">
            
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-robot me-2"></i>Atendimento FireNet</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" onclick="resetChat()"></button>
            </div>

            <div class="modal-body p-4 d-flex flex-column">
                
                <div class="progress mb-4" style="height: 5px; flex-shrink: 0;">
                    <div class="progress-bar bg-danger" id="progressBar" role="progressbar" style="width: 10%;"></div>
                </div>

                <div class="flex-grow-1 position-relative">

                    <div id="step-1" class="step-content animate__animated animate__fadeIn">
                        <h4 class="fw-bold text-dark mb-3">Olá! Bem-vindo à FireNet.</h4>
                        <p class="text-muted mb-4">Selecione uma opção abaixo para começar:</p>
                        
                        <div class="d-grid gap-3">
                            <button class="btn btn-outline-danger btn-lg text-start" onclick="goToStep('planos')">
                                <i class="fas fa-wifi me-2"></i> Conhecer nossos planos de internet
                            </button>
                            <button class="btn btn-outline-danger btn-lg text-start" onclick="goToStep('taxa')">
                                <i class="fas fa-tools me-2"></i> Detalhes da taxa de instalação
                            </button>
                            <button class="btn btn-outline-danger btn-lg text-start" onclick="goToStep('viabilidade')">
                                <i class="fas fa-map-marker-alt me-2"></i> Consultar disponibilidade no endereço
                            </button>
                            <button class="btn btn-outline-danger btn-lg text-start" onclick="goToStep('status')">
                                <i class="fas fa-calendar-day me-2"></i> Status do meu pedido de instalação
                            </button>
                            <button class="btn btn-outline-dark btn-lg text-start" onclick="verificarAtendimento('suporte')">
                                <i class="fas fa-headset me-2"></i> Outros assuntos (Suporte/Financeiro)
                            </button>
                        </div>
                    </div>

                    <div id="step-planos" class="step-content d-none animate__animated animate__fadeIn">
                        <h5 class="fw-bold mb-3"><button class="btn btn-sm btn-link text-muted p-0 me-2" onclick="goToStep(1)"><i class="fas fa-arrow-left"></i></button> Nossos Planos</h5>
                        
                        <div id="carouselPlanos" class="carousel slide carousel-dark" data-bs-ride="false">
                        <div class="carousel-inner px-5">
                            
                            <div class="carousel-item active">
                                <div class="card border-danger shadow-sm text-center" style="height: 400px;">
                                    <div class="card-header bg-danger text-white fw-bold">GAMER</div>
                                    <div class="card-body d-flex flex-column justify-content-center">
                                        <div class="mb-2">
                                            <span class="badge rounded-pill bg-light text-success border border-success">
                                                <i class="fas fa-unlock-alt me-1"></i> Livre de fidelidade
                                            </span>
                                        </div>

                                        <h2 class="text-danger fw-bold">1 GIGA</h2>
                                        <h3 class="card-title text-dark">R$ 159,99<small class="text-muted fs-6">/mês</small></h3>
                                        <hr>
                                        <ul class="list-unstyled text-start small mx-auto mb-4" style="max-width: 220px;">
                                            <li><i class="fas fa-check text-success me-2"></i>Wi-Fi 6 (AX)</li>
                                            <li><i class="fas fa-check text-success me-2"></i>Prioridade de Banda</li>
                                            <li><i class="fas fa-check text-success me-2"></i>Latência Mínima</li>
                                        </ul>
                                        
                                        <button class="btn btn-danger w-100 rounded-pill mt-auto" onclick="selecionarPlano('1 GIGA')">
                                            Contratar Agora
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="carousel-item">
                                <div class="card border-warning shadow-sm text-center position-relative" style="height: 400px;">
                                    <span class="position-absolute top-0 start-50 translate-middle-x mt-2 badge rounded-pill bg-warning text-dark" style="z-index: 10;">MAIS VENDIDO</span>
                                    <div class="card-header bg-dark text-white fw-bold mt-4">TURBO</div>
                                    <div class="card-body d-flex flex-column justify-content-center">
                                        <div class="mb-2">
                                            <span class="badge rounded-pill bg-light text-success border border-success">
                                                <i class="fas fa-unlock-alt me-1"></i> Livre de fidelidade
                                            </span>
                                        </div>

                                        <h2 class="text-danger fw-bold">700 MEGA</h2>
                                        <h3 class="card-title text-dark">R$ 129,90<small class="text-muted fs-6">/mês</small></h3>
                                        <hr>
                                        <ul class="list-unstyled text-start small mx-auto mb-4" style="max-width: 220px;">
                                            <li><i class="fas fa-check text-success me-2"></i>Wi-Fi Gigabit</li>
                                            <li><i class="fas fa-check text-success me-2"></i>Ultra Velocidade</li>
                                            <li><i class="fas fa-check text-success me-2"></i>Streaming 4K</li>
                                        </ul>
                                        
                                        <button class="btn btn-danger w-100 rounded-pill mt-auto" onclick="selecionarPlano('700 MEGAS')">
                                            Contratar Agora
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="carousel-item">
                                <div class="card border-danger shadow-sm text-center" style="height: 400px;">
                                    <div class="card-header bg-danger text-white fw-bold">BÁSICO</div>
                                    <div class="card-body d-flex flex-column justify-content-center">
                                        <div class="mb-2">
                                            <span class="badge rounded-pill bg-light text-success border border-success">
                                                <i class="fas fa-unlock-alt me-1"></i> Livre de fidelidade
                                            </span>
                                        </div>

                                        <h2 class="text-danger fw-bold">500 MEGA</h2>
                                        <h3 class="card-title text-dark">R$ 99,90<small class="text-muted fs-6">/mês</small></h3>
                                        <hr>
                                        <ul class="list-unstyled text-start small mx-auto mb-4" style="max-width: 220px;">
                                            <li><i class="fas fa-check text-success me-2"></i>Wi-Fi 5 Dual Band</li>
                                            <li><i class="fas fa-check text-success me-2"></i>Sinal Estável</li>
                                            <li><i class="fas fa-check text-success me-2"></i>Download Ilimitado</li>
                                        </ul>
                                        
                                        <button class="btn btn-danger w-100 rounded-pill mt-auto" onclick="selecionarPlano('500 MEGAS')">
                                            Contratar Agora
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#carouselPlanos" data-bs-slide="prev" style="width: 5%;">
                                <span class="carousel-control-prev-icon" aria-hidden="true" style="filter: invert(1);"></span>
                                <span class="visually-hidden">Anterior</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#carouselPlanos" data-bs-slide="next" style="width: 5%;">
                                <span class="carousel-control-next-icon" aria-hidden="true" style="filter: invert(1);"></span>
                                <span class="visually-hidden">Próximo</span>
                            </button>
                        </div>
                    </div>

                    <div id="step-status" class="step-content d-none animate__animated animate__fadeIn">
                        <h5 class="fw-bold mb-3"><button class="btn btn-sm btn-link text-muted p-0 me-2" onclick="goToStep(1)"><i class="fas fa-arrow-left"></i></button> Status do Pedido</h5>
                        
                        <p class="text-muted mb-3">Informe seu CPF para verificarmos o agendamento:</p>

                        <div class="input-group input-group-lg mb-3">
                            <input type="text" id="inputCpfStatus" class="form-control" placeholder="000.000.000-00" 
                                   oninput="mascaraCpf(this)" 
                                   onkeyup="if(event.key === 'Enter') consultarStatusPedido()">
                            <button class="btn btn-danger" type="button" id="btnCheckStatus" onclick="consultarStatusPedido()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>

                        <div id="resultadoStatus" class="d-none">
                            </div>
                    </div>

                   <div id="step-taxa" class="step-content d-none animate__animated animate__fadeIn">
                        <h5 class="fw-bold mb-3"><button class="btn btn-sm btn-link text-muted p-0 me-2" onclick="goToStep(1)"><i class="fas fa-arrow-left"></i></button> Taxa de Instalação</h5>
                        
                        <div class="alert alert-light border shadow-sm">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-danger text-white rounded-circle p-3 me-3">
                                    <i class="fas fa-tools fa-lg"></i>
                                </div>
                                <div>
                                    <h4 class="fw-bold text-danger mb-0">R$ 120,00</h4>
                                    <small class="text-muted">Valor da taxa única</small>
                                </div>
                            </div>
                            
                            <p class="mb-2"><strong>Áreas atendidas por esta taxa:</strong></p>
                            <ul class="mb-3 text-muted small">
                                <li><i class="fas fa-map-pin me-2 text-danger"></i>Pilares</li>
                                <li><i class="fas fa-map-pin me-2 text-danger"></i>Inhaúma</li>
                                <li><i class="fas fa-map-pin me-2 text-danger"></i>Tomás Coelho</li>
                                <li><i class="fas fa-map-pin me-2 text-danger"></i>Engenho da Rainha</li>
                            </ul>

                            <div class="bg-light p-3 rounded border">
                                <p class="mb-2 fw-bold small"><i class="fas fa-info-circle me-1 text-primary"></i> Informações de Pagamento:</p>
                                <ul class="mb-0 small text-muted list-unstyled">
                                    <li class="mb-1">1. O pagamento é feito <strong>diretamente ao técnico</strong> após a instalação.</li>
                                    <li>2. Aceitamos:</li>
                                    <li class="ms-3"><i class="fas fa-money-bill-wave text-success me-1"></i> Dinheiro (Espécie)</li>
                                    <li class="ms-3"><i class="fa-brands fa-pix text-primary me-1"></i> Pix</li>
                                </ul>
                            </div>
                        </div>
                        
                        <button class="btn btn-outline-danger w-100 rounded-pill mt-2" onclick="goToStep('explicacao-taxa')">
                            Entenda o que a taxa cobre <i class="fas fa-chevron-right ms-1"></i>
                        </button>
                    </div>

                    <div id="step-explicacao-taxa" class="step-content d-none animate__animated animate__fadeIn">
                        <h5 class="fw-bold mb-3">
                            <button class="btn btn-sm btn-link text-muted p-0 me-2" onclick="goToStep('taxa')"><i class="fas fa-arrow-left"></i></button> 
                            Detalhes da Taxa
                        </h5>
                        
                        <div class="card border-danger shadow-sm mb-4">
                            <div class="card-body bg-light rounded">
                                <div class="text-center mb-3 mt-2">
                                    <i class="fas fa-tools fa-3x text-danger mb-3"></i>
                                    <h5 class="fw-bold text-dark">Para que serve esse valor?</h5>
                                </div>
                                <p class="text-muted text-center mb-2 small">
                                    A taxa de instalação é um valor único destinado a cobrir os custos operacionais para ativar sua conexão com a máxima qualidade.
                                </p>
                            </div>
                        </div>

                        <h6 class="fw-bold text-dark mb-3"><i class="fas fa-box-open text-danger me-2"></i>O que está incluso:</h6>
                        
                        <div class="d-flex flex-column gap-2 mb-4">
                            <div class="p-3 border rounded bg-white shadow-sm d-flex align-items-center">
                                <div class="bg-danger text-white rounded-circle p-2 me-3 d-flex justify-content-center align-items-center" style="width: 40px; height: 40px;">
                                    <i class="fas fa-network-wired"></i>
                                </div>
                                <div>
                                    <strong class="d-block text-dark">Materiais Físicos</strong>
                                    <span class="small text-muted">Fibra óptica, conectores, passivos de rede e demais materiais.</span>
                                </div>
                            </div>

                            <div class="p-3 border rounded bg-white shadow-sm d-flex align-items-center">
                                <div class="bg-danger text-white rounded-circle p-2 me-3 d-flex justify-content-center align-items-center" style="width: 40px; height: 40px;">
                                    <i class="fas fa-hdd"></i>
                                </div>
                                <div>
                                    <strong class="d-block text-dark">Equipamentos</strong>
                                    <span class="small text-muted">Aparelho ONT (Modem/Roteador) comodatado e configurado.</span>
                                </div>
                            </div>

                            <div class="p-3 border rounded bg-white shadow-sm d-flex align-items-center">
                                <div class="bg-danger text-white rounded-circle p-2 me-3 d-flex justify-content-center align-items-center" style="width: 40px; height: 40px;">
                                    <i class="fas fa-hard-hat"></i>
                                </div>
                                <div>
                                    <strong class="d-block text-dark">Mão de Obra</strong>
                                    <span class="small text-muted">Deslocamento e tempo de serviço (homem/hora) do técnico.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="step-viabilidade" class="step-content d-none animate__animated animate__fadeIn">
                        <h5 class="fw-bold mb-3"><button class="btn btn-sm btn-link text-muted p-0 me-2" onclick="goToStep(1)"><i class="fas fa-arrow-left"></i></button> Disponibilidade</h5>
                        
                        <p class="text-muted mb-3">Digite seu CEP para verificarmos se atendemos sua rua:</p>

                        <div class="input-group input-group-lg mb-3">
                            <input type="text" id="inputCepModal" class="form-control" placeholder="00000-000" maxlength="9" 
                                   oninput="mascaraCep(this)" 
                                   onkeyup="if(event.key === 'Enter') consultarViabilidadeModal()">
                            <button class="btn btn-danger" type="button" id="btnConsultarModal" onclick="consultarViabilidadeModal()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>

                        <div id="resultadoViabilidadeModal" class="d-none">
                            </div>
                    </div>

                    <div id="step-2" class="step-content d-none animate__animated animate__fadeIn">
                        <h5 class="fw-bold mb-3"><button class="btn btn-sm btn-link text-muted p-0 me-2" onclick="goToStep(1)"><i class="fas fa-arrow-left"></i></button> Outros Assuntos</h5>
                        <p class="text-muted mb-3">Selecione uma opção:</p>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-dark text-start" onclick="goToStep(3)">
                                <i class="fas fa-wrench me-2"></i> Suporte técnico
                            </button>
                            <button class="btn btn-outline-dark text-start" onclick="selectOption('financeiro', 'Emissão ou 2ª via de boletos', true)">
                                <i class="fas fa-barcode me-2"></i> Emissão ou 2ª via de boletos
                            </button>
                            <button class="btn btn-outline-dark text-start" onclick="selectOption('financeiro', 'Reativação após pagamento')">
                                <i class="fas fa-power-off me-2"></i> Reativação após pagamento
                            </button>
                            <button class="btn btn-outline-dark text-start" onclick="selectOption('suporte', 'Mudança de endereço')">
                                <i class="fas fa-truck me-2"></i> Mudança de endereço
                            </button>
                            <button class="btn btn-outline-dark text-start" onclick="selectOption('financeiro', 'Cancelamento de plano')">
                                <i class="fas fa-ban me-2"></i> Cancelamento de plano
                            </button>
                            <button class="btn btn-outline-dark text-start" onclick="selectOption('suporte', 'Outros assuntos')">
                                <i class="fas fa-question-circle me-2"></i> Outros assuntos
                            </button>
                            <button class="btn btn-link text-danger mt-2" onclick="goToStep(1)">
                                Voltar ao menu anterior
                            </button>
                        </div>
                    </div>

                    <div id="step-3" class="step-content d-none animate__animated animate__fadeIn">
                        <h5 class="fw-bold mb-3"><button class="btn btn-sm btn-link text-muted p-0 me-2" onclick="goToStep(2)"><i class="fas fa-arrow-left"></i></button> Suporte Técnico</h5>
                        <p class="text-muted mb-3">Qual o problema técnico?</p>
                        
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-dark text-start" onclick="selectOption('suporte', 'Lentidão na internet')">
                                <i class="fas fa-tachometer-alt me-2"></i> Lentidão na internet
                            </button>
                            <button class="btn btn-outline-dark text-start" onclick="selectOption('suporte', 'Sem internet')">
                                <i class="fas fa-globe-americas me-2"></i> Sem internet / Sinal caiu
                            </button>
                            <button class="btn btn-outline-dark text-start" onclick="selectOption('suporte', 'Oscilação no sinal')">
                                <i class="fas fa-wave-square me-2"></i> Oscilação no sinal
                            </button>
                            <button class="btn btn-outline-dark text-start" onclick="selectOption('suporte', 'Outros problemas técnicos')">
                                <i class="fas fa-question me-2"></i> Outros problemas técnicos
                            </button>
                            <button class="btn btn-link text-danger mt-2" onclick="goToStep(2)">
                                Voltar ao menu anterior
                            </button>
                        </div>
                    </div>

                    <div id="step-identificacao" class="step-content d-none animate__animated animate__fadeIn">
                        <h5 class="fw-bold mb-3">
                            <button class="btn btn-sm btn-link text-muted p-0 me-2" onclick="goBackFromId()"><i class="fas fa-arrow-left"></i></button> 
                            Identificação
                        </h5>
                        <p class="text-muted" id="textoInstrucaoCpf">Para prosseguir com <strong><span id="lblAssuntoSelecionado"></span></strong>, precisamos localizar seu cadastro.</p>

                        <div id="blocoInputCpf">
                            <div class="form-group mb-3">
                                <label class="fw-bold small">Seu CPF</label>
                                <input type="text" id="inputCpfChat" class="form-control form-control-lg" placeholder="000.000.000-00" 
                                       oninput="mascaraCpf(this)" 
                                       onkeyup="if(event.key === 'Enter') processarIdentificacao()">
                                <small class="text-danger d-none" id="msgErroCpf">CPF inválido ou não informado.</small>
                            </div>
                            
                            <button class="btn btn-danger w-100 rounded-pill mt-3" id="btnBuscarCpf" onclick="processarIdentificacao()">
                                Continuar <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>

                        <div id="blocoNaoEncontrado" class="d-none animate__animated animate__fadeIn">
                            <div class="alert alert-warning border-warning shadow-sm text-center">
                                <i class="fas fa-search-minus fa-3x mb-3 text-warning"></i><br>
                                <strong class="d-block mb-2 text-dark">Desculpe, não localizamos esse CPF em nossa base.</strong>
                                <span class="small text-muted">Isso significa que você ainda não é cliente? Deseja conhecer nossos planos?</span>
                            </div>
                            
                            <div class="d-grid gap-2 mt-3">
                                <button class="btn btn-danger rounded-pill fw-bold" onclick="goToStep('planos')">
                                    <i class="fas fa-wifi me-2"></i> Sim, quero conhecer os planos
                                </button>
                                <button class="btn btn-outline-secondary rounded-pill" onclick="resetChat()">
                                    Não, encerrar atendimento
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="step-apps" class="step-content d-none text-center animate__animated animate__fadeIn">
                        <h5 class="fw-bold mb-4">
                             <button class="btn btn-sm btn-link text-muted p-0 me-2" onclick="goToStep(2)"><i class="fas fa-arrow-left"></i></button>
                             Aplicativo FireNet
                        </h5>
                        <div class="alert alert-info border-0 shadow-sm">
                            <i class="fas fa-mobile-alt fa-2x mb-2"></i><br>
                            <strong>Dica:</strong> Pegue sua 2ª via mais rápido pelo app!
                        </div>
                        <div class="d-flex justify-content-center gap-3 my-4">
                            <a href="https://play.google.com/store/apps/details?id=br.com.appdoprovedor.firenet" target="_blank" class="btn btn-dark btn-lg"><i class="fab fa-google-play me-2"></i> Android</a>
                            <a href="https://apps.apple.com/br/app/firenet/id6748965421" target="_blank" class="btn btn-dark btn-lg"><i class="fab fa-apple me-2"></i> iOS</a>
                        </div>
                        <button class="btn btn-outline-success rounded-pill px-4" onclick="finalizarParaWhatsapp()">
                            Ir para o WhatsApp <i class="fab fa-whatsapp ms-2"></i>
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalWhatsOcupado" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="fas fa-clock me-2"></i>Fora do Horário</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body py-4">
        <div class="card mb-4 border-danger" style="background-color: rgba(211, 47, 47, 0.08);">
            <div class="card-body text-center">
                <div class="text-danger mb-2"><i class="fas fa-store-slash fa-3x"></i></div>
                <h5 class="fw-bold text-danger">Atendimento Encerrado</h5>
                
                <p class="text-dark small mb-0 mt-2">
                    {{ mensagem_indisponibilidade }}
                </p>
                
                <hr class="border-danger opacity-25 my-3">
                <p class="mb-0 text-dark"><strong>Você ainda pode:</strong><br>Consultar planos e disponibilidade e realizar o pré-cadastro pelo site.</p>
            </div>
        </div>
        <div class="d-grid gap-2">
            <a href="{{ url_for('contato') }}" class="btn btn-danger rounded-pill"><i class="fas fa-envelope me-2"></i>Deixar Mensagem</a>
            <button type="button" class="btn btn-link text-muted text-decoration-none btn-sm" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    const LOJA_ABERTA = {{ 'true' if whatsapp_ativo else 'false' }};
    const NUMERO_VENDAS = "{{ whatsapp_sales }}";
    const NUMERO_SUPORTE = "{{ whatsapp_support }}";

    let flowState = {
        assunto: '',
        tipo: '', 
        isBoleto: false,
        dadosCliente: { nome: '', endereco: '', cpf: '' },
        plano: '' // NOVO: Armazena o plano selecionado
    };

    const mensagensPorAssunto = {
        'Lentidão na internet': 'Estou enfrentando lentidão na minha internet e preciso de suporte.',
        'Sem internet': 'Estou sem conexão de internet e preciso de ajuda para restabelecer o sinal.',
        'Oscilação no sinal': 'Minha internet está oscilando muito e preciso de verificação técnica.',
        'Outros problemas técnicos': 'Estou com um problema técnico específico e preciso de atendimento.',
        'Emissão ou 2ª via de boletos': 'Gostaria de solicitar a emissão da segunda via do meu boleto.',
        'Reativação após pagamento': 'Efetuei o pagamento da minha fatura e gostaria de solicitar a reativação do sinal.',
        'Mudança de endereço': 'Vou me mudar e gostaria de solicitar a transferência de endereço da minha instalação.',
        'Cancelamento de plano': 'Gostaria de solicitar o cancelamento do meu plano de internet.',
        'Outros assuntos': 'Gostaria de tratar de um assunto administrativo sobre meu plano.'
    };

    function resetChat() {
        goToStep(1);
        flowState = { assunto: '', tipo: '', isBoleto: false, dadosCliente: { nome: '', endereco: '', cpf: '' }, plano: '' };
        
        // Limpa os inputs e remove classes de validação
        ['inputCpfChat', 'inputNomeChat', 'inputEndChat', 'inputCepModal', 'inputCpfStatus'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.value = '';
                el.classList.remove('is-valid', 'is-invalid');
            }
        });
        
        // Esconde mensagens de erro e blocos condicionais
        ['resultadoViabilidadeModal', 'camposManuais', 'resultadoStatus', 'msgErroCpf', 'blocoNaoEncontrado'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.classList.add('d-none');
        });
        
        // Restaura a visibilidade do bloco de CPF padrão
        const blocoInputCpf = document.getElementById('blocoInputCpf');
        if(blocoInputCpf) blocoInputCpf.classList.remove('d-none');
        
        const textoInstrucaoCpf = document.getElementById('textoInstrucaoCpf');
        if(textoInstrucaoCpf) textoInstrucaoCpf.classList.remove('d-none');
        
        const btnBuscarCpf = document.getElementById('btnBuscarCpf');
        if (btnBuscarCpf) {
            btnBuscarCpf.innerHTML = 'Continuar <i class="fas fa-arrow-right ms-2"></i>';
            btnBuscarCpf.disabled = false;
        }
    }

    function verificarAtendimento(destino) {
        if (!LOJA_ABERTA) {
            const modalOcupado = new bootstrap.Modal(document.getElementById('modalWhatsOcupado'));
            modalOcupado.show();
            return;
        }

        if (destino === 'suporte') {
            goToStep(2);
        } else if (destino === 'vendas_direta') {
            selectOption('vendas', 'Gostaria de contratar um plano');
        }
    }

    function goToStep(step) {
        document.querySelectorAll('.step-content').forEach(el => el.classList.add('d-none'));
        
        let id = `step-${step}`;
        if(step === 'identificacao') id = 'step-identificacao';
        if(step === 'apps') id = 'step-apps';
        
        const target = document.getElementById(id);
        if(target) target.classList.remove('d-none');

        let progress = 10;
        if(step === 'planos' || step === 'taxa' || step === 'viabilidade' || step === 'status') progress = 30;
        if(step === 'explicacao-taxa') progress = 40;
        if(step === 2) progress = 40;
        if(step === 3) progress = 60;
        if(step === 'identificacao') progress = 80;
        if(step === 'apps') progress = 90;
        document.getElementById('progressBar').style.width = `${progress}%`;
    }

    // --- NOVA FUNÇÃO: Seleciona Plano e vai para Viabilidade ---
    function selecionarPlano(plano) {
        flowState.plano = plano; // Guarda o plano
        goToStep('viabilidade'); // Vai para a tela de CEP
    }

    function mascaraCep(i) {
        let v = i.value.replace(/\D/g, '');
        if (v.length > 5) v = v.substring(0, 5) + '-' + v.substring(5, 8);
        i.value = v;
    }

    // --- FUNÇÃO DE VALIDAÇÃO MATEMÁTICA DO CPF ---
    function validarCPF(cpf) {
        cpf = cpf.replace(/[^\d]+/g, ''); 
        if (cpf == '') return false;
        
        if (cpf.length != 11 || 
            /^(\d)\1{10}$/.test(cpf)) // Regex que pega 111..., 222...
                return false;
        
        let add = 0;
        for (let i = 0; i < 9; i++) add += parseInt(cpf.charAt(i)) * (10 - i);
        let rev = 11 - (add % 11);
        if (rev == 10 || rev == 11) rev = 0;
        if (rev != parseInt(cpf.charAt(9))) return false;
        
        add = 0;
        for (let i = 0; i < 10; i++) add += parseInt(cpf.charAt(i)) * (11 - i);
        rev = 11 - (add % 11);
        if (rev == 10 || rev == 11) rev = 0;
        if (rev != parseInt(cpf.charAt(10))) return false;
        
        return true;   
    }

    function mascaraCpf(i) {
        let v = i.value.replace(/\D/g, "");
        if (v.length > 11) v = v.slice(0, 11);
        v = v.replace(/(\d{3})(\d)/, "$1.$2");
        v = v.replace(/(\d{3})(\d)/, "$1.$2");
        v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
        i.value = v;

        i.classList.remove('is-invalid', 'is-valid');
        document.getElementById('msgErroCpf').classList.add('d-none');

        if (i.value.length === 14) {
            if (validarCPF(i.value)) {
                i.classList.add('is-valid'); 
            } else {
                i.classList.add('is-invalid'); 
            }
        }
    }

    function consultarStatusPedido() {
        const cpfInput = document.getElementById('inputCpfStatus');
        const resDiv = document.getElementById('resultadoStatus');
        const btn = document.getElementById('btnCheckStatus');
        const cpf = cpfInput.value.replace(/\D/g, '');

        if (cpf.length < 11) {
            resDiv.className = 'alert alert-warning mt-3';
            resDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Digite um CPF válido.';
            resDiv.classList.remove('d-none');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        fetch('/api/check_status', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ cpf: cpf })
        })
        .then(r => r.json())
        .then(data => {
            resDiv.classList.remove('d-none');
            
            if (data.found) {
                const status = data.status;
                const dataInstalacao = data.data || 'Data não definida';
                let mensagem = '';
                let icone = '';
                let cor = '';

                if (status === 'N/D') {
                    icone = 'fa-clock';
                    cor = 'alert-warning';
                    mensagem = 'Sua instalação ainda não foi agendada. Fique atento ao seu e-mail, pois novas informações serão enviadas em breve.';
                } else if (status === 'Programada') {
                    icone = 'fa-calendar-check';
                    cor = 'alert-info';
                    mensagem = `Sua instalação está programada para o dia <strong>${dataInstalacao}</strong>.`;
                } else if (status === 'Concluída') {
                    icone = 'fa-check-circle';
                    cor = 'alert-success';
                    mensagem = `Sua instalação foi concluída no dia <strong>${dataInstalacao}</strong>.`;
                } else {
                    icone = 'fa-info-circle';
                    cor = 'alert-secondary';
                    mensagem = `Status atual: ${status}`;
                }

                resDiv.className = `alert ${cor} mt-3 text-center`;
                resDiv.innerHTML = `<i class="fas ${icone} fa-2x mb-2"></i><br>${mensagem}`;

            } else {
                resDiv.className = 'alert alert-danger mt-3 text-center';
                resDiv.innerHTML = `
                    <i class="fas fa-times-circle mb-2"></i><br>
                    <strong>Não existe nenhuma instalação cadastrada para este CPF.</strong><br>
                    <hr>
                    <p class="mb-2">Quer se tornar nosso cliente?</p>
                    <button class="btn btn-danger btn-sm w-100 rounded-pill" onclick="goToStep('planos')">
                        Conhecer Planos e Contratar
                    </button>
                `;
            }
        })
        .catch(err => {
            console.error(err);
            resDiv.className = 'alert alert-danger mt-3';
            resDiv.innerHTML = 'Erro ao consultar. Tente novamente.';
            resDiv.classList.remove('d-none');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search"></i>';
        });
    }

    function consultarViabilidadeModal() {
        const cepInput = document.getElementById('inputCepModal');
        const resDiv = document.getElementById('resultadoViabilidadeModal');
        const btn = document.getElementById('btnConsultarModal');
        const cep = cepInput.value.replace(/\D/g, '');

        if (cep.length !== 8) {
            resDiv.className = 'alert alert-warning mt-3';
            resDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> CEP inválido.';
            resDiv.classList.remove('d-none');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        resDiv.className = 'alert alert-info mt-3';
        resDiv.innerHTML = 'Consultando...';
        resDiv.classList.remove('d-none');

        fetch(`https://viacep.com.br/ws/${cep}/json/`)
        .then(r => r.json())
        .then(data => {
            if (data.erro) throw new Error('CEP não encontrado.');
            return fetch('/check_cobertura', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    logradouro: data.logradouro,
                    bairro: data.bairro,
                    cidade: data.localidade,
                    estado: data.uf
                })
            }).then(r => r.json()).then(backendData => ({...data, coberta: backendData.coberta}));
        })
        .then(info => {
            if (info.coberta) {
                // ATUALIZADO: Constrói o link com CEP e, se existir, o PLANO
                let linkCadastro = `/cadastro?cep=${cep}`;
                if (flowState.plano) {
                    linkCadastro += `&plano=${encodeURIComponent(flowState.plano)}`;
                }
                
                resDiv.className = 'alert alert-success mt-3';
                resDiv.innerHTML = `
                    <strong><i class="fas fa-check-circle"></i> Temos Cobertura!</strong><br>
                    Atendemos a <strong>${info.logradouro}</strong>.<br>
                    <a href="${linkCadastro}" class="btn btn-success btn-sm w-100 mt-2 fw-bold">
                        Ir para Cadastro <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                `;
            } else {
                resDiv.className = 'alert alert-danger mt-3';
                resDiv.innerHTML = `
                    <strong><i class="fas fa-times-circle"></i> Sem Cobertura.</strong><br>
                    Infelizmente ainda não atendemos a <strong>${info.logradouro}</strong>.
                `;
            }
        })
        .catch(err => {
            resDiv.className = 'alert alert-warning mt-3';
            resDiv.innerHTML = 'Erro ao consultar. Verifique o CEP.';
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-search"></i>';
        });
    }

    function selectOption(tipo, assunto, isBoleto = false) {
        if (!LOJA_ABERTA) {
            const modalOcupado = new bootstrap.Modal(document.getElementById('modalWhatsOcupado'));
            modalOcupado.show();
            return;
        }

        flowState.tipo = tipo;
        flowState.assunto = assunto;
        flowState.isBoleto = isBoleto;

        if (tipo === 'vendas') {
            finalizarParaWhatsapp();
        } else {
            document.getElementById('lblAssuntoSelecionado').innerText = assunto;
            goToStep('identificacao');
        }
    }

    function goBackFromId() {
        const tecnicos = ['Lentidão', 'Sem internet', 'Oscilação', 'Outros problemas'];
        if(tecnicos.some(t => flowState.assunto.includes(t))) goToStep(3);
        else goToStep(2);
    }

    function processarIdentificacao() {
        const cpfInput = document.getElementById('inputCpfChat');
        const cpf = cpfInput.value;
        const btn = document.getElementById('btnBuscarCpf');
        const msgErro = document.getElementById('msgErroCpf');

        if (!validarCPF(cpf)) {
            msgErro.innerHTML = "CPF inválido. Verifique os números digitados.";
            msgErro.classList.remove('d-none');
            cpfInput.classList.add('is-invalid');
            cpfInput.focus();
            return;
        }
        
        msgErro.classList.add('d-none');
        cpfInput.classList.remove('is-invalid');
        cpfInput.classList.add('is-valid');

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        fetch('/api/consultar_cpf', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ cpf: cpf })
        })
        .then(r => r.json())
        .then(data => {
            if (data.found) {
                // Cliente encontrado: segue para o WhatsApp normalmente
                flowState.dadosCliente = { nome: data.nome, endereco: data.endereco, cpf: cpf };
                posIdentificacao();
            } else {
                // Cliente NÃO encontrado: esconde o form e mostra o aviso de conversão
                document.getElementById('blocoInputCpf').classList.add('d-none');
                document.getElementById('textoInstrucaoCpf').classList.add('d-none');
                document.getElementById('blocoNaoEncontrado').classList.remove('d-none');
            }
        })
        .catch(() => {
            msgErro.innerHTML = "Erro ao consultar o sistema. Tente novamente.";
            msgErro.classList.remove('d-none');
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = 'Continuar <i class="fas fa-arrow-right ms-2"></i>';
        });
    }

    function posIdentificacao() {
        if (flowState.isBoleto) goToStep('apps');
        else finalizarParaWhatsapp();
    }

    function finalizarParaWhatsapp() {
        if (!LOJA_ABERTA) {
            const modalOcupado = new bootstrap.Modal(document.getElementById('modalWhatsOcupado'));
            modalOcupado.show();
            return;
        }

        const h = new Date().getHours();
        let saudacao = h < 12 ? 'Bom dia' : h < 18 ? 'Boa tarde' : 'Boa noite';
        let texto = '';

        if (flowState.tipo === 'vendas') {
            texto = `${saudacao}! ${flowState.assunto}.`;
        } else {
            const { nome, endereco, cpf } = flowState.dadosCliente;
            const fraseNatural = mensagensPorAssunto[flowState.assunto] || `Gostaria de falar sobre: ${flowState.assunto}.`;
            texto = `${saudacao}. Meu nome é *${nome}*, CPF *${cpf}*, meu endereço de instalação é *${endereco}*. ${fraseNatural}`;
        }

        const numero = flowState.tipo === 'vendas' ? NUMERO_VENDAS : NUMERO_SUPORTE;
        window.open(`https://wa.me/${numero}?text=${encodeURIComponent(texto)}`, '_blank');
        
        setTimeout(() => {
            const modalEl = document.getElementById('modalAtendenteVirtual');
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) {
                modalInstance.hide();
            }
            resetChat();
        }, 2000);
    }
</script>