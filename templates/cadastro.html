<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FireNet Telecom - Cadastro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"/>

  <style>
    /* Step wizard */
    .stepper { counter-reset: step; }
    .stepper .step-dot::before {
      counter-increment: step;
      content: counter(step);
      display: inline-flex; align-items:center; justify-content:center;
      width: 36px; height: 36px; border-radius: 50%;
      background: #dc3545; color: #fff; font-weight: 700;
    }
    .stepper .step-line { height: 2px; background: #e9ecef; }
    .stepper .active .step-dot::before { background: #dc3545; }
    .stepper .done .step-dot::before { background: #198754; }
    .step { display: none; }
    .step.active { display: block; }
  </style>
</head>
<body>

<header class="bg-white shadow-sm py-3 sticky-top">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <a href="/"><img src="{{ url_for('static', filename='logo.png') }}" alt="FireNet Telecom" class="logo-firenet"/></a>
      <nav class="d-none d-md-flex gap-4">
        <a href="/#inicio" class="nav-link text-dark fw-medium">Início</a>
        <a href="/#planos" class="nav-link text-dark fw-medium">Planos</a>
        <a href="/#vantagens" class="nav-link text-dark fw-medium">Vantagens</a>
        <a href="/#cobertura" class="nav-link text-dark fw-medium">Cobertura</a>
        <a href="/#central" class="nav-link text-dark fw-medium">Central do Cliente</a>
        <a href="/cadastro" class="nav-link text-dark fw-medium">Cadastro</a>
        <a href="/contato" class="nav-link text-dark fw-medium">Contato</a>
      </nav>
      <button class="btn btn-outline-danger d-md-none" data-bs-toggle="collapse" data-bs-target="#navMobile">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <div class="collapse mt-3" id="navMobile">
      <nav class="d-flex flex-column text-center gap-2">
        <a href="/#inicio" class="py-2 text-dark">Início</a>
        <a href="/#planos" class="py-2 text-dark">Planos</a>
        <a href="/#vantagens" class="py-2 text-dark">Vantagens</a>
        <a href="/#cobertura" class="py-2 text-dark">Cobertura</a>
        <a href="/#central" class="py-2 text-dark">Central do Cliente</a>
        <a href="/cadastro" class="py-2 text-dark">Cadastro</a>
        <a href="/contato" class="py-2 text-dark">Contato</a>
      </nav>
    </div>
  </div>
</header>

<main>
<section class="py-5 bg-light">
  <div class="container">
    <h2 class="text-center text-danger mb-4">Faça Seu Cadastro</h2>
    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <div class="stepper d-flex align-items-center gap-2 mb-4">
      <div class="text-center flex-fill">
        <div class="step-dot mx-auto"></div>
        <small class="d-block mt-2">Endereço de Instalação</small>
      </div>
      <div class="step-line flex-fill"></div>
      <div class="text-center flex-fill">
        <div class="step-dot mx-auto"></div>
        <small class="d-block mt-2">Dados Pessoais</small>
      </div>
      <div class="step-line flex-fill"></div>
      <div class="text-center flex-fill">
        <div class="step-dot mx-auto"></div>
        <small class="d-block mt-2">Dados de Contato</small>
      </div>
      <div class="step-line flex-fill"></div>
      <div class="text-center flex-fill">
        <div class="step-dot mx-auto"></div>
        <small class="d-block mt-2">Plano & LGPD</small>
      </div>
    </div>

    <form action="/cadastro" method="POST" id="cadastro-form" novalidate>
      <!-- ETAPA 1: Endereço de Instalação (antiga etapa 3) -->
      <div class="step active" data-step="1">
        <div class="mb-3">
          <label for="cep" class="form-label">Qual o seu CEP? *</label>
          <input type="text" class="form-control" id="cep" name="cep" required maxlength="9"/>
          <div id="cep-error" class="text-danger" style="display:none">Endereço inexistente. Por favor, insira um CEP válido.</div>
        </div>

        <!-- Endereço (display + hidden) -->
        <div class="mb-3">
          <label for="rua" class="form-label">Qual o seu endereço? *</label>
          <input type="text" class="form-control" id="rua" required readonly/>
          <input type="hidden" id="rua_hidden" name="rua"/>
          <input type="hidden" id="bairro" name="bairro"/>
          <input type="hidden" id="cidade" name="cidade"/>
          <input type="hidden" id="estado" name="estado"/>
          <div id="cobertura-error" class="text-danger" style="display:none">Rua sem cobertura da FireNet Telecom.</div>
        </div>

        <!-- Número + Complemento -->
        <div class="row g-3 mb-3">
          <div class="col-12 col-md-6">
            <label for="numero" class="form-label">Número da sua residência? *</label>
            <input type="text" class="form-control" id="numero" name="numero" required/>
          </div>
          <div class="col-12 col-md-6">
            <label for="complemento" class="form-label">Qual o complemento?</label>
            <input type="text" class="form-control" id="complemento" name="complemento"/>
          </div>
        </div>

        <div class="mb-3">
          <label for="ponto_referencia" class="form-label">Qual é o ponto de Referência? *</label>
          <input type="text" class="form-control" id="ponto_referencia" name="ponto_referencia" required/>
        </div>

        <div class="d-flex justify-content-end">
          <button type="button" class="btn btn-danger rounded-pill" id="next-1" disabled>Prosseguir</button>
        </div>
      </div>

      <!-- ETAPA 2: Dados Pessoais (antiga etapa 1) -->
      <div class="step" data-step="2">
        <div class="mb-3">
          <label for="nome" class="form-label">Qual é o seu nome completo? *</label>
          <input type="text" class="form-control" id="nome" name="nome" required/>
        </div>
        <div class="mb-3">
          <label for="cpf" class="form-label">Qual é seu CPF? *</label>
          <input type="text" class="form-control" id="cpf" name="cpf" required maxlength="14"/>
          <div id="cpf-error" class="text-danger" style="display:none">CPF inválido. Por favor, insira um CPF válido.</div>
          <div id="cpf-exists-error" class="text-danger" style="display:none">CPF já cadastrado, favor entrar em contato via WhatsApp.</div>
        </div>
        <div class="mb-3">
          <label for="rg" class="form-label">Qual seu RG (carteira de identidade)? *</label>
          <input type="text" class="form-control" id="rg" name="rg" required maxlength="12"/>
        </div>
        <div class="mb-3">
          <label for="data_nascimento" class="form-label">Qual é a sua data de nascimento? *</label>
          <input type="date" class="form-control" id="data_nascimento" name="data_nascimento" max="9999-12-31" required/>
        </div>
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-outline-danger rounded-pill" id="back-2">Voltar</button>
          <button type="button" class="btn btn-danger rounded-pill" id="next-2" disabled>Prosseguir</button>
        </div>
      </div>

      <!-- ETAPA 3: Dados de Contato (antiga etapa 2) -->
      <div class="step" data-step="3">
        <div class="mb-3">
          <label for="telefone" class="form-label">Qual é o seu telefone de contato (com DDD)? *</label>
          <input type="tel" class="form-control" id="telefone" name="telefone" required maxlength="15"/>
        </div>
        <div class="mb-3">
          <label for="whatsapp" class="form-label">O número informado é WhatsApp? *</label>
          <select class="form-select" id="whatsapp" name="whatsapp" required>
            <option value="">Selecione uma opção</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">Qual é o seu e-mail? *</label>
          <input type="email" class="form-control" id="email" name="email" required/>
          <div id="email-error" class="text-danger" style="display:none">E-mail inválido. Por favor, insira um e-mail válido.</div>
        </div>
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-outline-danger rounded-pill" id="back-3">Voltar</button>
          <button type="button" class="btn btn-danger rounded-pill" id="next-3" disabled>Prosseguir</button>
        </div>
      </div>

      <!-- ETAPA 4: Plano & LGPD -->
      <div class="step" data-step="4">
        <div class="mb-3">
          <label for="plano" class="form-label">Qual é o plano Desejado? *</label>
          <select class="form-select" id="plano" name="plano" required>
            <option value="">Selecione um plano</option>
            <option value="1 GIGA">1 GIGA - R$ 159,99</option>
            <option value="700 MEGAS">700 MEGAS - R$ 129,90</option>
            <option value="500 MEGAS">500 MEGAS - R$ 99,90</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="vencimento" class="form-label">Qual é o dia de vencimento desejado? *</label>
          <select class="form-select" id="vencimento" name="vencimento" required>
            <option value="">Selecione o dia de vencimento</option>
            <option value="Dia 5">Dia 5</option>
            <option value="Dia 10">Dia 10</option>
            <option value="Dia 15">Dia 15</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="nome_rede" class="form-label">Qual o nome da REDE WIFI que deseja? *</label>
          <input type="text" class="form-control" id="nome_rede" name="nome_rede" required/>
        </div>
        <div class="mb-3">
          <label for="senha_rede" class="form-label">E qual é a senha que deseja usar (mínimo 8 e máximo 10 caracteres)? *</label>
          <input type="text" class="form-control" id="senha_rede" name="senha_rede" required minlength="8" maxlength="10"/>
          <div id="senha-error" class="text-danger" style="display:none">A senha deve ter entre 8 e 10 caracteres.</div>
        </div>
        <div class="mb-3 form-check">
          <input type="checkbox" class="form-check-input" id="lgpd" name="lgpd" value="Sim" required/>
          <label class="form-check-label" for="lgpd">
            Declaro que estou fornecendo estas informações exclusivamente para fins de cadastro e formalização da assinatura do serviço de internet oferecido pela empresa FireNet. Estou ciente de que os dados enviados serão tratados de acordo com a LGPD (Lei nº 13.709/2018).
          </label>
        </div>

        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-outline-danger rounded-pill" id="back-4">Voltar</button>
          <button type="submit" class="btn btn-danger rounded-pill" id="submit-btn" disabled>Enviar</button>
        </div>
      </div>
    </form>
  </div>
</section>

<div class="modal fade" id="modalConfirmEmail" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-header bg-danger text-white border-0">
        <h5 class="modal-title fw-bold"><i class="fas fa-check-double me-2"></i>Confirmação de E-mail</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="alert alert-light border-start border-danger border-4 shadow-sm mb-4">
          <small class="text-muted fw-bold text-uppercase">Importante:</small>
          <p class="mb-0 text-dark small">
            Toda a comunicação sobre agendamento e instalação será enviada para este endereço. 
            <strong>Garanta que você tem acesso a ele.</strong>
          </p>
        </div>

        <div class="mb-3">
          <label class="form-label text-muted small">E-mail informado anteriormente:</label>
          <input type="text" class="form-control bg-light" id="email_display_readonly" readonly>
        </div>

        <div class="mb-1">
          <label for="email_confirma_input" class="form-label fw-bold">Confirme seu e-mail (digite novamente):</label>
          <input type="email" class="form-control form-control-lg" id="email_confirma_input" placeholder="seuemail@exemplo.com" onpaste="return false;">
        </div>
        <div id="email-match-error" class="text-danger small mt-1 d-none">
          <i class="fas fa-times-circle me-1"></i> Os e-mails não coincidem. Verifique a digitação.
        </div>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">Corrigir</button>
        <button type="button" class="btn btn-danger rounded-pill px-4" onclick="validarEmailEAvancar()">Confirmar e Prosseguir</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalTaxaInstalacao" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      
      <div class="modal-header bg-danger text-white border-0 rounded-top-4">
        <h5 class="modal-title fw-bold"><i class="fas fa-file-invoice-dollar me-2"></i>Taxa de Instalação</h5>
      </div>
      
      <div class="modal-body p-4 text-center"> <div class="alert alert-warning border-warning shadow-sm mb-4 text-start">
          <div class="d-flex align-items-center">
            <div class="me-3"><i class="fas fa-info-circle fa-2x text-warning"></i></div>
            <div>
              <p class="mb-0 fw-bold text-dark lh-sm">Para prosseguir, confirme a ciência do valor.</p>
            </div>
          </div>
        </div>

        <div class="card bg-light border-0 p-3 mb-4 text-center">
          <p class="mb-0 fw-medium text-muted text-uppercase small">Valor da Taxa Única</p>
          <p class="text-danger display-6 fw-bold mb-1">R$ 120,00</p>
          <div class="badge bg-dark rounded-pill px-3 py-2 mt-2">
            <i class="fas fa-wallet me-1"></i> Pagamento em Dinheiro (Espécie) ou PIX
          </div>
          <small class="text-muted d-block mt-2" style="font-size: 0.8rem;">
            *O pagamento é realizado diretamente ao técnico após a instalação.
          </small>
        </div>

        <div class="p-3 border rounded-3 bg-white hover-shadow">
            <div class="form-check d-flex justify-content-center align-items-center text-start">
                <input class="form-check-input mt-0 me-3" type="checkbox" id="checkAceiteTaxa" style="cursor: pointer; transform: scale(1.4); flex-shrink: 0;">
                <label class="form-check-label lh-sm" for="checkAceiteTaxa" style="cursor: pointer; user-select: none;">
                    Declaro que estou ciente que deverei efetuar o pagamento de <strong>R$ 120,00</strong> em <strong>Dinheiro ou PIX</strong> após a conclusão da instalação.
                </label>
            </div>
        </div>

      </div>
      
      <div class="modal-footer border-0 bg-light rounded-bottom-4 justify-content-between p-3">
        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" id="btnAbortarCadastro">
          <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <button type="button" class="btn btn-danger rounded-pill px-4 fw-bold shadow-sm" id="btnConfirmarTaxa" disabled>
          Continuar <i class="fas fa-arrow-right ms-2"></i>
        </button>
      </div>

    </div>
  </div>
</div>
      
      <div class="modal-footer border-0 bg-light rounded-bottom-4 justify-content-between p-3">
        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" id="btnAbortarCadastro">
          <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <button type="button" class="btn btn-danger rounded-pill px-4 fw-bold shadow-sm" id="btnConfirmarTaxa" disabled>
          Continuar <i class="fas fa-arrow-right ms-2"></i>
        </button>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="modalAbortoCadastro" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div class="modal-body p-4 text-center">
        <div class="mb-3 text-secondary opacity-50">
            <i class="fas fa-door-open fa-4x"></i>
        </div>
        <h5 class="fw-bold text-danger mb-2">Cadastro Cancelado</h5>
        <p class="text-muted small mb-4">
            Entendemos. Caso mude de ideia, estaremos por aqui esperando por você!
        </p>
        <a href="/" class="btn btn-dark w-100 rounded-pill">
            Voltar ao Início
        </a>
      </div>
    </div>
  </div>
</div>

</main>
{% include 'whatsapp_widget.html' %}

{% include 'footer.html' %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // ===== util: debounce para "validar assim que termina de digitar" =====
  function debounce(fn, wait = 350) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(null, args), wait);
    };
  }

  // ===== Helpers (máscaras apenas em input) =====
// Nome: capitalização (compatível com acentos)
const nomeInput = document.getElementById('nome');
nomeInput.addEventListener('input', function (e) {
  const texto = e.target.value
    .toLowerCase()
    .replace(/(^|[\s\-'])+(\p{L})/gu, (m) => m.toUpperCase());
  e.target.value = texto;
  updateNavButtons();
});

  // RG mask
  const rgInput = document.getElementById('rg');
  rgInput.addEventListener('input', function (e) {
    let v = e.target.value.replace(/\D/g, '');
    v = v.replace(/^(\d{2})(\d)/, '$1.$2');
    v = v.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
    v = v.replace(/^(\d{2})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3-$4');
    e.target.value = v.substring(0, 12);
    updateNavButtons();
  });

  // CPF mask + validação imediata
  const cpfInput = document.getElementById('cpf');
  const cpfError = document.getElementById('cpf-error');
  const cpfExistsError = document.getElementById('cpf-exists-error');
  let cpfExists = false;
  let coberturaError = false;

  cpfInput.addEventListener('input', function (e) {
    let v = e.target.value.replace(/\D/g, '');
    v = v.replace(/(\d{3})(\d)/, '$1.$2');
    v = v.replace(/(\d{3})\.(\d{3})(\d)/, '$1.$2.$3');
    v = v.replace(/(\d{3})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3-$4');
    e.target.value = v;

    // validação instantânea quando completar 14 chars
    cpfError.style.display = 'none';
    cpfExistsError.style.display = 'none';
    cpfExists = false;
    if (e.target.value.length === 14) {
      if (!validarCPF(e.target.value)) {
        cpfError.style.display = 'block';
      } else {
        debouncedCheckCpfExists(e.target.value);
      }
    }
    updateNavButtons();
  });

  // Telefone mask
  const telefoneInput = document.getElementById('telefone');
  telefoneInput.addEventListener('input', function (e) {
    let v = e.target.value.replace(/\D/g, '');
    v = v.replace(/^(\d{2})(\d)/g, '($1) $2');
    v = v.replace(/(\d)(\d{4})$/, '$1-$2');
    e.target.value = v;
    updateNavButtons();
  });

  // CEP mask + busca imediata
  const cepInput = document.getElementById('cep');
  const cepError = document.getElementById('cep-error');
  cepInput.addEventListener('input', function (e) {
    let v = e.target.value.replace(/\D/g, '');
    e.target.value = v.replace(/(\d{5})(\d)/, '$1-$2');
    debouncedViaCep();
  });

  // E-mail validação instantânea
  const emailInput = document.getElementById('email');
  const emailError = document.getElementById('email-error');
  emailInput.addEventListener('input', debounce(function (e) {
    const emailRegex = /^[\w\.-]+@[\w\.-]+\.\w+$/;
    emailError.style.display = e.target.value && !emailRegex.test(e.target.value) ? 'block' : 'none';
    updateNavButtons();
  }, 300));

  // Inputs simples que devem atualizar o estado imediatamente
  ['data_nascimento','whatsapp','numero','complemento','ponto_referencia','plano','vencimento','nome_rede','lgpd']
    .forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      const evt = (el.tagName === 'SELECT') || id === 'lgpd' ? 'change' : 'input';
      el.addEventListener(evt, () => {
        updateNavButtons();
        updateSubmitState();
      });
    });

  // Senha com validação instantânea e habilitação do "Enviar"
  const senhaInput = document.getElementById('senha_rede');
  const senhaError = document.getElementById('senha-error');
  senhaInput.addEventListener('input', function () {
    const senha = senhaInput.value || '';
    const ok = senha.length >= 8 && senha.length <= 10;
    senhaError.style.display = senha && !ok ? 'block' : 'none';
    updateSubmitState();
  });

  // ===== Validadores e checagens =====
  function validarCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
    let soma = 0, resto;
    for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i-1, i)) * (11 - i);
    resto = (soma * 10) % 11; if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(9, 10))) return false;
    soma = 0;
    for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i-1, i)) * (12 - i);
    resto = (soma * 10) % 11; if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(10, 11))) return false;
    return true;
  }

  async function checkCpfExists(cpfValue) {
    try {
      const response = await fetch('/check_cpf', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cpf: cpfValue.replace(/\D/g, '') })
      });
      const data = await response.json();
      return data.exists;
    } catch { return false; }
  }

  const debouncedCheckCpfExists = debounce(async (v) => {
    const exists = await checkCpfExists(v);
    cpfExists = !!exists;
    cpfExistsError.style.display = cpfExists ? 'block' : 'none';
    updateNavButtons();
  }, 400);

  // CEP -> ViaCEP (instantâneo ao completar 8 dígitos)
  function clearAddressFields() {
    document.getElementById('rua').value = '';
    document.getElementById('rua_hidden').value = '';
    document.getElementById('bairro').value = '';
    document.getElementById('cidade').value = '';
    document.getElementById('estado').value = '';
  }

  function fetchViaCepNow() {
    const v = cepInput.value.replace(/\D/g, '');
    cepError.style.display = 'none';
    coberturaError = false;  // Reseta erro de cobertura
    document.getElementById('cobertura-error').style.display = 'none';
    if (v.length !== 8) { clearAddressFields(); updateNavButtons(); return; }

    fetch(`https://viacep.com.br/ws/${v}/json/`)
      .then(r => r.json())
      .then(async data => {
        if (data.erro) {
          cepError.style.display = 'block';
          clearAddressFields();
          updateNavButtons();
          return;
        }

        const logradouro = data.logradouro || '';
        const bairro = data.bairro || '';
        const cidade = data.localidade || '';
        const uf = data.uf || '';
        const display = [logradouro, bairro, cidade, uf].filter(Boolean).join(', ');
        document.getElementById('rua').value = display;
        document.getElementById('rua_hidden').value = logradouro;
        document.getElementById('bairro').value = bairro;
        document.getElementById('cidade').value = cidade;
        document.getElementById('estado').value = uf;

        // Verifica cobertura no backend
        try {
          const response = await fetch('/check_cobertura', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ logradouro, bairro, cidade, uf })
          });
          const result = await response.json();
          coberturaError = !result.coberta;
          document.getElementById('cobertura-error').style.display = coberturaError ? 'block' : 'none';
        } catch (e) {
          console.error('Erro ao verificar cobertura:', e);
          coberturaError = true;
          document.getElementById('cobertura-error').style.display = 'block';
          clearAddressFields();
        }

        updateNavButtons();
      })
      .catch(() => { 
        cepError.style.display = 'block'; 
        clearAddressFields(); 
        updateNavButtons(); 
      });
  }

  const debouncedViaCep = debounce(fetchViaCepNow, 400);

  // ===== Navegação entre etapas =====
  const steps = Array.from(document.querySelectorAll('.step'));
  const stepperDots = Array.from(document.querySelectorAll('.stepper .step-dot').values());
  let current = 0; // 0..3

  function setStep(idx) {
    steps.forEach((s, i) => s.classList.toggle('active', i === idx));
    stepperDots.forEach((dot, i) => {
      dot.parentElement.classList.remove('active','done');
      if (i < idx) dot.parentElement.classList.add('done');
      if (i === idx) dot.parentElement.classList.add('active');
    });
    current = idx;
    updateNavButtons();
    updateSubmitState();
  }

  function validateStep(idx) {
    if (idx === 0) {  // Nova Etapa 1: Endereço
      const ruaVis = document.getElementById('rua').value.trim();
      const ruaHidden = document.getElementById('rua_hidden').value.trim();
      const bairro = document.getElementById('bairro').value.trim();
      const numero = document.getElementById('numero').value.trim();
      const pr = document.getElementById('ponto_referencia').value.trim();
      if (!ruaVis || !ruaHidden || !bairro || !numero || !pr) return false;
      if (cepError.style.display !== 'none' || coberturaError) return false;
      return true;
    }
    if (idx === 1) {  // Nova Etapa 2: Dados Pessoais
      const nome = nomeInput.value.trim();
      const cpfV = cpfInput.value;
      const rg = rgInput.value.trim();
      const dn = document.getElementById('data_nascimento').value;
      if (!nome || !rg || !dn) return false;
      if (cpfV.length !== 14 || !validarCPF(cpfV)) return false;
      if (cpfExists) return false;
      return true;
    }
    if (idx === 2) {  // Nova Etapa 3: Contato
      const tel = telefoneInput.value.trim();
      const wa = document.getElementById('whatsapp').value;
      const email = emailInput.value;
      const emailRegex = /^[\w\.-]+@[\w\.-]+\.\w+$/;
      return !!tel && !!wa && !!email && emailRegex.test(email);
    }
    if (idx === 3) {  // Etapa 4: Plano & LGPD
      const plano = document.getElementById('plano').value;
      const venc = document.getElementById('vencimento').value;
      const nomeRede = document.getElementById('nome_rede').value.trim();
      const senha = senhaInput.value;
      const lgpd = document.getElementById('lgpd').checked;
      const senhaOk = senha.length >= 8 && senha.length <= 10;
      return !!plano && !!venc && !!nomeRede && senhaOk && lgpd;
    }
    return true;
  }

  function updateNavButtons() {
    const next1 = document.getElementById('next-1');
    const next2 = document.getElementById('next-2');
    const next3 = document.getElementById('next-3');

    if (current === 0 && next1) next1.disabled = !validateStep(0);
    if (current === 1 && next2) next2.disabled = !validateStep(1);
    if (current === 2 && next3) next3.disabled = !validateStep(2);
  }

  // Botões de navegação
  // --- Lógica do Modal de Taxa e Cancelamento ---
  // 1. Abrir Modal ao clicar em Prosseguir na Etapa 1
  document.getElementById('next-1').addEventListener('click', async () => {
    if (validateStep(0)) {
      // Abre o modal de Taxa
      const modalTaxa = new bootstrap.Modal(document.getElementById('modalTaxaInstalacao'));
      modalTaxa.show();
    }
  });

  // 2. Habilita o botão "Continuar" apenas se marcar o checkbox
  document.getElementById('checkAceiteTaxa').addEventListener('change', function() {
      const btnConfirmar = document.getElementById('btnConfirmarTaxa');
      btnConfirmar.disabled = !this.checked;
      
      // Efeito visual opcional: muda a cor do checkbox container
      if(this.checked) {
          this.parentElement.classList.add('border-danger', 'bg-light');
      } else {
          this.parentElement.classList.remove('border-danger', 'bg-light');
      }
  });

  // 3. Botão "Continuar" do Modal -> Vai para a Etapa 2
  document.getElementById('btnConfirmarTaxa').addEventListener('click', function() {
      const modalEl = document.getElementById('modalTaxaInstalacao');
      const modalInstance = bootstrap.Modal.getInstance(modalEl);
      modalInstance.hide();
      setStep(1); // Avança para Dados Pessoais
  });

  // 4. Botão "Cancelar" -> Abre o Modal Bonito de Aborto
  document.getElementById('btnAbortarCadastro').addEventListener('click', function() {
      // Fecha o modal da taxa
      const modalTaxaEl = document.getElementById('modalTaxaInstalacao');
      const modalTaxa = bootstrap.Modal.getInstance(modalTaxaEl);
      modalTaxa.hide();

      // Abre o modal de cancelamento
      const modalAborto = new bootstrap.Modal(document.getElementById('modalAbortoCadastro'));
      modalAborto.show();
  });

  document.getElementById('back-2').addEventListener('click', () => setStep(0));
  document.getElementById('next-2').addEventListener('click', async () => {
    // segurança extra: rechecagem de CPF duplicado
    if (cpfInput.value.length === 14 && validarCPF(cpfInput.value)) {
      const exists = await checkCpfExists(cpfInput.value);
      cpfExists = !!exists;
      if (cpfExists) cpfExistsError.style.display = 'block';
    }
    if (validateStep(1)) setStep(2);
  });
  document.getElementById('back-3').addEventListener('click', () => setStep(1));
  
  // --- Alteração: Botão da Etapa 3 agora abre o Modal ---
  document.getElementById('next-3').addEventListener('click', () => { 
    if (validateStep(2)) {
      // 1. Pega o e-mail digitado
      const emailOriginal = document.getElementById('email').value;
      
      // 2. Preenche o campo 'readonly' do modal para referência
      document.getElementById('email_display_readonly').value = emailOriginal;
      
      // 3. Limpa o campo de confirmação e erro
      const inputConfirm = document.getElementById('email_confirma_input');
      inputConfirm.value = '';
      inputConfirm.classList.remove('is-invalid');
      document.getElementById('email-match-error').classList.add('d-none');
      
      // 4. Abre o modal
      const modalEmail = new bootstrap.Modal(document.getElementById('modalConfirmEmail'));
      modalEmail.show();

      // Foca no input após abrir
      document.getElementById('modalConfirmEmail').addEventListener('shown.bs.modal', () => {
          inputConfirm.focus();
      }, { once: true });
    } 
  });

  // Função chamada pelo botão "Confirmar" dentro do Modal
  function validarEmailEAvancar() {
    const emailOriginal = document.getElementById('email').value.trim();
    const emailConfirm = document.getElementById('email_confirma_input').value.trim();
    const errorDiv = document.getElementById('email-match-error');
    const inputConfirm = document.getElementById('email_confirma_input');

    if (emailOriginal.toLowerCase() === emailConfirm.toLowerCase()) {
      // SUCESSO: E-mails batem
      // 1. Fecha modal
      const modalEl = document.getElementById('modalConfirmEmail');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();

      // 2. Avança para a próxima etapa (Plano)
      setStep(3); 
    } else {
      // ERRO: E-mails diferentes
      errorDiv.classList.remove('d-none');
      inputConfirm.classList.add('is-invalid');
    }
  }

  // Permitir dar "Enter" no modal para confirmar
  document.getElementById('email_confirma_input').addEventListener('keydown', (e) => {
    if(e.key === 'Enter') validarEmailEAvancar();
  });
  
  document.getElementById('back-4').addEventListener('click', () => setStep(2));

  // Submit habilitado somente quando a última etapa estiver válida
  function updateSubmitState() {
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = !validateStep(3);
  }

  // Validação final no submit
  const form = document.getElementById('cadastro-form');
  form.addEventListener('submit', async function (e) {
    // última verificação CPF
    if (cpfInput.value.length === 14 && validarCPF(cpfInput.value)) {
      const exists = await checkCpfExists(cpfInput.value);
      cpfExists = !!exists;
      if (cpfExists) cpfExistsError.style.display = 'block';
    }
    if (!validateStep(3)) {
      e.preventDefault();
      setStep(3);
      return;
    }
  });

  // Inicializa estado
  setStep(0);
</script>

<script>
  // --- LÓGICA DE PERSISTÊNCIA (AUTO-PREENCHIMENTO VIA URL) ---
  document.addEventListener('DOMContentLoaded', function() {
    const params = new URLSearchParams(window.location.search);
    
    // 1. Preencher Plano
    const planoParam = params.get('plano');
    const planoSelect = document.getElementById('plano');
    
    if (planoParam && planoSelect) {
      // Tenta definir o valor. Se o valor existir nas <option>, será selecionado.
      planoSelect.value = planoParam;
      // Dispara evento 'change' para garantir que qualquer lógica visual atrelada ao select corra
      planoSelect.dispatchEvent(new Event('change'));
    }

    // 2. Preencher CEP e disparar busca automática
    const cepParam = params.get('cep');
    const cepInput = document.getElementById('cep');
    
    if (cepParam && cepInput) {
      // Garante que usamos apenas números
      let cleanCep = cepParam.replace(/\D/g, '');
      
      if (cleanCep.length === 8) {
        // Define o valor "cru" primeiro
        cepInput.value = cleanCep;
        
        // Dispara o evento 'input'. 
        // Isto é CRUCIAL: fará com que o seu script existente (que tem o listener de máscara e o debounce)
        // detete a mudança, aplique a máscara (XXXXX-XXX) e chame o ViaCEP automaticamente.
        cepInput.dispatchEvent(new Event('input'));
      }
    }
  });
</script>
</body>
</html>
