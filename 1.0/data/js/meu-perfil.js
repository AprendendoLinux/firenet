(function() {
    const DEBUG = false; // Ativei temporariamente para ajudar no diagn√≥stico

    function debugLog(...args) {
        if (DEBUG) {
            console.log(...args);
        }
    }

    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'flex';
            if (modalId === 'modal-2fa') {
                reset2FAForm();
            }
            enableAllButtonsInModal(modalId);
            debugLog(`Modal aberto: ${modalId}`);
        } else {
            debugLog(`Modal n√£o encontrado: ${modalId}`);
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            modal.querySelectorAll('.modal-error').forEach(el => el.style.display = 'none');
            modal.querySelectorAll('.modal-success').forEach(el => el.style.display = 'none');
            if (modalId === 'modal-2fa') {
                reset2FAForm();
            }
            debugLog(`Modal fechado: ${modalId}`);
        } else {
            debugLog(`Modal n√£o encontrado: ${modalId}`);
        }
    }

    function showError(modalId, message) {
        const errorDiv = document.getElementById(`${modalId}-error`);
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            debugLog(`Erro exibido em ${modalId}: ${message}`);
            // Armazenar o ID do modal para reabertura ap√≥s recarregamento
            if (modalId === 'password' || modalId === 'telegram') {
                sessionStorage.setItem('reopenModal', `modal-${modalId}`);
                debugLog(`Modal ${modalId} armazenado para reabertura`);
            }
            // Recarregar a p√°gina ap√≥s 1 segundo para permitir nova tentativa
            setTimeout(() => {
                debugLog(`Recarregando p√°gina ap√≥s erro em ${modalId}`);
                location.reload();
            }, 1000);
        }
    }

    function showSuccess(modalId, message) {
        const successDiv = document.getElementById(`${modalId}-success`);
        if (successDiv) {
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            debugLog(`Sucesso exibido em ${modalId}: ${message}`);
        }
    }

    function disableAllButtonsInModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        const buttons = modal.querySelectorAll('button');
        buttons.forEach(button => {
            button.disabled = true;
            button.classList.add('disabled');
        });
        debugLog(`Todos os bot√µes desativados no modal: ${modalId}`);
    }

    function enableAllButtonsInModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        const buttons = modal.querySelectorAll('button');
        buttons.forEach(button => {
            button.disabled = false;
            button.classList.remove('disabled');
        });
        debugLog(`Todos os bot√µes ativados no modal: ${modalId}`);
    }

    function reset2FAForm() {
        const errorDiv = document.getElementById('2fa-error');
        const successDiv = document.getElementById('2fa-success');
        const selectionDiv = document.getElementById('2fa-selection');
        const qrSectionDiv = document.getElementById('2fa-qr-section');
        const qrImage = document.getElementById('qr-code-image');
        if (errorDiv) errorDiv.style.display = 'none';
        if (successDiv) successDiv.style.display = 'none';
        if (selectionDiv) selectionDiv.style.display = 'block';
        if (qrSectionDiv) qrSectionDiv.style.display = 'none';
        if (qrImage) qrImage.src = '';
        debugLog('Formul√°rio 2FA redefinido');
    }

    // Associar eventos aos bot√µes de a√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
        const openPasswordModalBtn = document.getElementById('open-password-modal');
        const open2FAModalBtn = document.getElementById('open-2fa-modal');
        const openTelegramModalBtn = document.getElementById('open-telegram-modal');
        const openLogsModalBtn = document.getElementById('open-logs-modal');

        if (openPasswordModalBtn) {
            openPasswordModalBtn.addEventListener('click', () => openModal('modal-password'));
        } else {
            debugLog('Bot√£o open-password-modal n√£o encontrado');
        }
        if (open2FAModalBtn) {
            open2FAModalBtn.addEventListener('click', () => openModal('modal-2fa'));
        } else {
            debugLog('Bot√£o open-2fa-modal n√£o encontrado');
        }
        if (openTelegramModalBtn) {
            openTelegramModalBtn.addEventListener('click', () => openModal('modal-telegram'));
        } else {
            debugLog('Bot√£o open-telegram-modal n√£o encontrado');
        }
        if (openLogsModalBtn) {
            openLogsModalBtn.addEventListener('click', () => openModal('modal-logs'));
        } else {
            debugLog('Bot√£o open-logs-modal n√£o encontrado');
        }
        debugLog('Ouvintes de eventos dos bot√µes de a√ß√£o associados');

        // Associar eventos aos bot√µes de fechar
        const closePasswordModalBtn = document.getElementById('close-password-modal');
        const close2FAModalBtn = document.getElementById('close-2fa-modal');
        const closeTelegramModalBtn = document.getElementById('close-telegram-modal');
        const closeLogsModalBtn = document.getElementById('close-logs-modal');

        if (closePasswordModalBtn) {
            closePasswordModalBtn.addEventListener('click', () => closeModal('modal-password'));
        } else {
            debugLog('Bot√£o close-password-modal n√£o encontrado');
        }
        if (close2FAModalBtn) {
            close2FAModalBtn.addEventListener('click', () => closeModal('modal-2fa'));
        } else {
            debugLog('Bot√£o close-2fa-modal n√£o encontrado');
        }
        if (closeTelegramModalBtn) {
            closeTelegramModalBtn.addEventListener('click', () => closeModal('modal-telegram'));
        } else {
            debugLog('Bot√£o close-telegram-modal n√£o encontrado');
        }
        if (closeLogsModalBtn) {
            closeLogsModalBtn.addEventListener('click', () => closeModal('modal-logs'));
        } else {
            debugLog('Bot√£o close-logs-modal n√£o encontrado');
        }
        debugLog('Ouvintes de eventos dos bot√µes de fechar associados');

        // Garantir que os bot√µes de a√ß√£o estejam habilitados
        document.querySelectorAll('.action-button').forEach(button => {
            button.disabled = false;
            button.classList.remove('disabled');
            debugLog(`Bot√£o de a√ß√£o habilitado: ${button.id}`);
        });

        // Verificar se h√° um modal para reabrir ap√≥s recarregamento
        const modalToReopen = sessionStorage.getItem('reopenModal');
        if (modalToReopen && (modalToReopen === 'modal-password' || modalToReopen === 'modal-telegram')) {
            openModal(modalToReopen);
            debugLog(`Modal reaberto ap√≥s recarregamento: ${modalToReopen}`);
            sessionStorage.removeItem('reopenModal'); // Limpar para evitar reaberturas indesejadas
        }

        // Abrir modal de confirma√ß√£o de 2FA, se necess√°rio
        const confirmModal = document.getElementById('modal-confirm-2fa');
        if (confirmModal) {
            openModal('modal-confirm-2fa');
            debugLog('Modal confirm-2fa aberto ao carregar');
        }

        // Alternar visibilidade da senha no modal de senhas
        document.querySelectorAll('#modal-password .toggle-password').forEach(toggle => {
            toggle.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const input = document.getElementById(targetId);
                if (input.type === 'password') {
                    input.type = 'text';
                    this.textContent = 'üôà'; // √çcone para "ocultar"
                } else {
                    input.type = 'password';
                    this.textContent = 'üëÅÔ∏è'; // √çcone para "mostrar"
                }
                debugLog(`Visibilidade da senha alternada para ${targetId}`);
            });
        });
    });

    const twoFAEnabledCheckbox = document.getElementById('2fa_enabled');
    if (twoFAEnabledCheckbox) {
        twoFAEnabledCheckbox.addEventListener('change', function() {
            const typeOptions = document.getElementById('2fa-type-options');
            if (typeOptions) {
                typeOptions.style.display = this.checked ? 'block' : 'none';
                debugLog(`Checkbox 2FA alterado: ${this.checked}`);
            }
        });
    }

    // Modal de Configura√ß√£o de 2FA (#modal-2fa)
    const twoFAForm = document.getElementById('2fa-form');
    if (twoFAForm) {
        twoFAForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const submitButton = document.getElementById('2fa-submit');
            if (submitButton) {
                submitButton.classList.add('validating');
            }
            const errorDiv = document.getElementById('2fa-error');
            const successDiv = document.getElementById('2fa-success');
            if (errorDiv) errorDiv.style.display = 'none';
            if (successDiv) successDiv.style.display = 'none';

            disableAllButtonsInModal('modal-2fa');

            const formData = new FormData();
            formData.append('ajax_2fa_validate', '1');
            formData.append('2fa_enabled', document.getElementById('2fa_enabled').checked ? '1' : '0');
            const type = document.querySelector('input[name="2fa_type"]:checked')?.value || 'email';
            formData.append('2fa_type', type);

            debugLog('Enviando formul√°rio 2FA', { habilitado: document.getElementById('2fa_enabled').checked, tipo: type });

            fetch('meu-perfil.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                debugLog('Resposta do formul√°rio 2FA', data);
                if (data.success) {
                    showSuccess('2fa', data.message);
                    if (data.qrCode) {
                        const selectionDiv = document.getElementById('2fa-selection');
                        const qrSectionDiv = document.getElementById('2fa-qr-section');
                        const qrImage = document.getElementById('qr-code-image');
                        const secretKeyInput = document.getElementById('secret-key');
                        if (selectionDiv) selectionDiv.style.display = 'none';
                        if (qrSectionDiv) qrSectionDiv.style.display = 'block';
                        if (qrImage) qrImage.src = data.qrCode;
                        if (data.secret && secretKeyInput) {
                            secretKeyInput.value = data.secret;
                        }
                        showSuccess('2fa-qr', data.message);
                        enableAllButtonsInModal('modal-2fa');
                    } else {
                        setTimeout(() => {
                            closeModal('modal-2fa');
                            location.reload();
                        }, 650);
                    }
                } else {
                    showError('2fa', data.message);
                    enableAllButtonsInModal('modal-2fa');
                }
            })
            .catch(error => {
                showError('2fa', 'Erro ao processar a solicita√ß√£o: ' + error.message);
                enableAllButtonsInModal('modal-2fa');
                debugLog('Erro no formul√°rio 2FA', error);
            });
        });
    }

    const proceedButton = document.getElementById('proceed-totp-button');
    if (proceedButton) {
        proceedButton.addEventListener('click', function() {
            disableAllButtonsInModal('modal-2fa');
            closeModal('modal-2fa');
            location.reload();
            debugLog('Bot√£o Prosseguir TOTP clicado');
        });
    }

    const cancelButton = document.getElementById('cancel-totp-button');
    if (cancelButton) {
        cancelButton.addEventListener('click', function() {
            disableAllButtonsInModal('modal-2fa');
            const errorDiv = document.getElementById('2fa-error');
            const successDiv = document.getElementById('2fa-success');
            const qrErrorDiv = document.getElementById('2fa-qr-error');
            const qrSuccessDiv = document.getElementById('2fa-qr-success');
            if (errorDiv) errorDiv.style.display = 'none';
            if (successDiv) successDiv.style.display = 'none';
            if (qrErrorDiv) qrErrorDiv.style.display = 'none';
            if (qrSuccessDiv) qrSuccessDiv.style.display = 'none';

            const formData = new FormData();
            formData.append('ajax_cancel_2fa', '1');

            debugLog('Bot√£o Cancelar TOTP clicado');

            fetch('meu-perfil.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                debugLog('Resposta do cancelamento TOTP', data);
                if (data.success) {
                    showSuccess('2fa', data.message);
                    setTimeout(() => {
                        closeModal('modal-2fa');
                        location.reload();
                    }, 650);
                } else {
                    showError('2fa', data.message);
                    enableAllButtonsInModal('modal-2fa');
                }
            })
            .catch(error => {
                showError('2fa', 'Erro ao processar a solicita√ß√£o: ' + error.message);
                enableAllButtonsInModal('modal-2fa');
                debugLog('Erro no cancelamento TOTP', error);
            });
        });
    }

    const copySecretButton = document.getElementById('copy-secret-button');
    const secretKeyInput = document.getElementById('secret-key');
    if (copySecretButton && secretKeyInput) {
        copySecretButton.addEventListener('click', function() {
            secretKeyInput.select();
            try {
                document.execCommand('copy');
                copySecretButton.textContent = 'Copiado!';
                copySecretButton.classList.add('copied');
                setTimeout(() => {
                    copySecretButton.textContent = 'Copiar';
                    copySecretButton.classList.remove('copied');
                }, 2000);
                debugLog('Chave secreta copiada');
            } catch (err) {
                showError('2fa-qr', 'Erro ao copiar a chave.');
                debugLog('Erro ao copiar a chave secreta', err);
            }
        });
    }

    const confirm2FAForm = document.getElementById('confirm-2fa-form');
    if (confirm2FAForm) {
        confirm2FAForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const submitButton = document.getElementById('confirm-2fa-submit');
            if (submitButton) {
                submitButton.classList.add('validating');
            }
            const errorDiv = document.getElementById('confirm-2fa-error');
            const successDiv = document.getElementById('confirm-2fa-success');
            if (errorDiv) errorDiv.style.display = 'none';
            if (successDiv) successDiv.style.display = 'none';

            disableAllButtonsInModal('modal-confirm-2fa');

            const formData = new FormData(this);

            debugLog('Enviando formul√°rio de confirma√ß√£o 2FA');

            fetch('meu-perfil.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                debugLog('Resposta da confirma√ß√£o 2FA', data);
                if (data.success) {
                    showSuccess('confirm-2fa', data.message);
                    setTimeout(() => {
                        closeModal('modal-confirm-2fa');
                        location.reload();
                    }, 650);
                } else {
                    showError('confirm-2fa', data.message);
                    enableAllButtonsInModal('modal-confirm-2fa');
                }
            })
            .catch(error => {
                showError('confirm-2fa', 'Erro ao processar a solicita√ß√£o: ' + error.message);
                enableAllButtonsInModal('modal-confirm-2fa');
                debugLog('Erro na confirma√ß√£o 2FA', error);
            });
        });
    }

    const resend2FAButton = document.getElementById('resend-2fa-button');
    if (resend2FAButton) {
        resend2FAButton.addEventListener('click', function() {
            disableAllButtonsInModal('modal-confirm-2fa');
            const errorDiv = document.getElementById('confirm-2fa-error');
            const successDiv = document.getElementById('confirm-2fa-success');
            if (errorDiv) errorDiv.style.display = 'none';
            if (successDiv) successDiv.style.display = 'none';

            const formData = new FormData();
            formData.append('ajax_resend_2fa', '1');

            debugLog('Bot√£o Reenviar Token 2FA clicado');

            fetch('meu-perfil.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                debugLog('Resposta do reenvio 2FA', data);
                if (data.success) {
                    showSuccess('confirm-2fa', data.message);
                    enableAllButtonsInModal('modal-confirm-2fa');
                } else {
                    showError('confirm-2fa', data.message);
                    enableAllButtonsInModal('modal-confirm-2fa');
                }
            })
            .catch(error => {
                showError('confirm-2fa', 'Erro ao processar a solicita√ß√£o: ' + error.message);
                enableAllButtonsInModal('modal-confirm-2fa');
                debugLog('Erro no reenvio 2FA', error);
            });
        });
    }

    const cancel2FAButton = document.getElementById('cancel-2fa-button');
    if (cancel2FAButton) {
        cancel2FAButton.addEventListener('click', function() {
            disableAllButtonsInModal('modal-confirm-2fa');
            const errorDiv = document.getElementById('confirm-2fa-error');
            const successDiv = document.getElementById('confirm-2fa-success');
            if (errorDiv) errorDiv.style.display = 'none';
            if (successDiv) successDiv.style.display = 'none';

            const formData = new FormData();
            formData.append('ajax_cancel_2fa', '1');

            debugLog('Bot√£o Cancelar 2FA clicado');

            fetch('meu-perfil.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                debugLog('Resposta do cancelamento 2FA', data);
                if (data.success) {
                    showSuccess('confirm-2fa', data.message);
                    setTimeout(() => {
                        closeModal('modal-confirm-2fa');
                        location.reload();
                    }, 650);
                } else {
                    showError('confirm-2fa', data.message);
                    enableAllButtonsInModal('modal-confirm-2fa');
                }
            })
            .catch(error => {
                showError('confirm-2fa', 'Erro ao processar a solicita√ß√£o: ' + error.message);
                enableAllButtonsInModal('modal-confirm-2fa');
                debugLog('Erro no cancelamento 2FA', error);
            });
        });
    }

    const passwordForm = document.getElementById('password-form');
    if (passwordForm) {
        passwordForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const submitButton = document.getElementById('password-submit');
            if (submitButton) {
                submitButton.classList.add('validating');
            }
            const errorDiv = document.getElementById('password-error');
            const successDiv = document.getElementById('password-success');
            if (errorDiv) errorDiv.style.display = 'none';
            if (successDiv) successDiv.style.display = 'none';

            disableAllButtonsInModal('modal-password');

            const formData = new FormData(this);

            debugLog('Enviando formul√°rio de senha');

            fetch('meu-perfil.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                debugLog('Resposta do formul√°rio de senha', data);
                if (data.success) {
                    showSuccess('password', data.message);
                    setTimeout(() => {
                        closeModal('modal-password');
                    }, 650);
                } else {
                    showError('password', data.message);
                    enableAllButtonsInModal('modal-password');
                }
            })
            .catch(error => {
                showError('password', 'Erro ao processar a solicita√ß√£o: ' + error.message);
                enableAllButtonsInModal('modal-password');
                debugLog('Erro no formul√°rio de senha', error);
            });
        });
    }

    const telegramForm = document.getElementById('telegram-form');
    if (telegramForm) {
        telegramForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const submitButton = document.getElementById('telegram-submit');
            if (submitButton) {
                submitButton.classList.add('validating');
            }
            const errorDiv = document.getElementById('telegram-error');
            const successDiv = document.getElementById('telegram-success');
            if (errorDiv) errorDiv.style.display = 'none';
            if (successDiv) successDiv.style.display = 'none';

            disableAllButtonsInModal('modal-telegram');

            const formData = new FormData(this);

            debugLog('Enviando formul√°rio de Telegram');

            fetch('meu-perfil.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                debugLog('Resposta do formul√°rio de Telegram', data);
                if (data.success) {
                    showSuccess('telegram', data.message);
                    setTimeout(() => {
                        closeModal('modal-telegram');
                        location.reload();
                    }, 650);
                } else {
                    showError('telegram', data.message);
                    enableAllButtonsInModal('modal-telegram');
                }
            })
            .catch(error => {
                showError('telegram', 'Erro ao processar a solicita√ß√£o: ' + error.message);
                enableAllButtonsInModal('modal-telegram');
                debugLog('Erro no formul√°rio de Telegram', error);
            });
        });
    }
})();
